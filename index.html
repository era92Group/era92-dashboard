<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>era92 Group — Live KPI Dashboard</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter+Tight:ital,wght@0,400;0,500;0,600;0,700;0,800&family=Instrument+Serif:ital@1&display=swap" rel="stylesheet">
<style>
:root {
  --orange: #FC5E27;
  --coral: #e8613e;
  --light-blue: #89D6E5;
  --dark-blue: #2690B1;
  --light-orange: #F2E3DB;
  --beige: #f3e4db;
  --bg-dark: #1f2025;
  --bg-card: #292a30;
  --bg-sidebar: #18191d;
  --bg-input: #33343b;
  --border: #3a3b42;
  --text: #f0ece8;
  --text-muted: #9d9a94;
  --text-dim: #6b6862;
  --positive: #4ADE80;
  --negative: #F87171;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Inter Tight', system-ui, -apple-system, sans-serif; background:var(--bg-dark); color:var(--text); display:flex; min-height:100vh; font-weight:400; }

/* ===== SIDEBAR ===== */
.sidebar {
  width: 260px; min-height: 100vh; background: var(--bg-sidebar);
  border-right: 1px solid var(--border); display: flex; flex-direction: column;
  position: fixed; left: 0; top: 0; bottom: 0; z-index: 50;
}
.sidebar-logo {
  padding: 28px 24px 24px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 14px;
}
.sidebar-logo .logo-icon {
  width: 40px; height: 40px; border-radius: 12px;
  background: linear-gradient(135deg, var(--orange) 0%, #ff4a39 100%);
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 11px; color: white; letter-spacing: -0.5px;
}
.sidebar-logo .logo-text { font-size: 17px; font-weight: 700; color: var(--text); letter-spacing: -0.3px; }
.sidebar-logo .logo-sub { font-size: 11px; font-weight: 400; color: var(--text-dim); margin-top: 2px; letter-spacing: 0.3px; }

.sidebar-nav { padding: 20px 14px; flex: 1; overflow-y: auto; }
.nav-label { font-size: 10px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.5px; padding: 12px 14px 8px; }
.nav-item {
  display: flex; align-items: center; gap: 12px; padding: 11px 14px; margin: 2px 0;
  border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 500;
  color: var(--text-muted); transition: all 0.2s;
}
.nav-item:hover { background: var(--bg-input); color: var(--text); }
.nav-item.active { background: linear-gradient(135deg, var(--orange) 0%, #e8613e 100%); color: white; box-shadow: 0 2px 12px rgba(252,94,39,0.25); }
.nav-item .nav-icon { width: 18px; height: 18px; opacity: 0.65; flex-shrink:0; }
.nav-item.active .nav-icon { opacity: 1; }
.nav-item .nav-badge { font-size: 10px; font-weight: 500; margin-left: auto; opacity: 0.5; text-transform: uppercase; letter-spacing: 0.5px; }

.sidebar-footer {
  padding: 18px 24px; border-top: 1px solid var(--border);
  font-size: 11px; color: var(--text-dim);
}

/* ===== MAIN CONTENT ===== */
.main { margin-left: 260px; flex: 1; min-height: 100vh; }

/* Top bar */
.topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 18px 36px; border-bottom: 1px solid var(--border);
  background: var(--bg-sidebar);
}
.topbar-left { display: flex; align-items: center; gap: 16px; }
.topbar-title { font-size: 20px; font-weight: 700; letter-spacing: -0.3px; }
.topbar-subtitle { font-size: 13px; font-weight: 400; color: var(--text-muted); }
.topbar-right { display: flex; align-items: center; gap: 14px; }
.currency-toggle {
  display: flex; background: var(--bg-input); border-radius: 8px; overflow: hidden; border: 1px solid var(--border);
}
.currency-toggle button {
  padding: 6px 14px; border: none; background: transparent; color: var(--text-muted);
  font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s;
}
.currency-toggle button.active { background: var(--orange); color: white; }
.refresh-btn {
  background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted);
  padding: 7px 16px; border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: 600;
  font-family: inherit; transition: all 0.15s; letter-spacing: 0.2px;
}
.refresh-btn:hover { border-color: var(--orange); color: var(--text); }

/* Filters */
.filter-bar {
  display: flex; gap: 12px; padding: 14px 36px; border-bottom: 1px solid var(--border);
  background: var(--bg-dark); flex-wrap: wrap; align-items: center;
}
.filter-group { display: flex; align-items: center; gap: 6px; }
.filter-group label { font-size: 10px; color: var(--text-dim); font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; }
.filter-group select {
  padding: 6px 12px; border: 1px solid var(--border); border-radius: 8px;
  font-size: 12px; color: var(--text); background: var(--bg-input);
  cursor: pointer; font-family: inherit;
}
.filter-group select:focus { border-color: var(--orange); outline: none; }
.filter-group select option { background: var(--bg-card); color: var(--text); }

/* KPI Strip */
.kpi-strip {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px; padding: 28px 36px 12px;
}
.kpi-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 14px; padding: 22px; transition: border-color 0.2s, transform 0.2s;
}
.kpi-card:hover { border-color: rgba(137,214,229,0.25); transform: translateY(-2px); }
.kpi-card .kpi-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 10px; font-weight: 600; }
.kpi-card .kpi-value { font-family: 'Instrument Serif', serif; font-style: italic; font-size: 32px; font-weight: 400; color: #89D6E5; letter-spacing: -0.5px; }
.kpi-card .kpi-sub { font-size: 12px; font-weight: 500; color: var(--text-dim); margin-top: 4px; }
.kpi-card .kpi-icon {
  width: 34px; height: 34px; border-radius: 10px; display: flex;
  align-items: center; justify-content: center; margin-bottom: 14px; font-size: 16px; font-weight:700;
}

/* Section content */
.page-content { padding: 20px 36px 36px; }
.section { display: none; }
.section.active { display: block; }
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.full { grid-column: 1 / -1; }

.card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 14px; padding: 26px; transition: border-color 0.2s;
}
.card:hover { border-color: rgba(252,94,39,0.2); }
.card h3 {
  font-size: 11px; font-weight: 700; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 18px;
}
.card canvas { width: 100% !important; max-height: 280px; }

.section-header {
  margin-bottom: 24px;
}
.section-header h2 {
  font-size: 24px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 4px;
}
.section-header p {
  font-size: 14px; font-weight: 400; color: var(--text-muted);
}

.insight-box {
  background: rgba(252,94,39,0.04); border-left: 3px solid var(--orange);
  padding: 16px 20px; border-radius: 0 12px 12px 0; margin-bottom: 22px;
  font-size: 13px; line-height: 1.7; color: var(--text-muted); backdrop-filter: blur(4px);
}
.insight-box strong { color: var(--orange); }

/* Loading */
.loading-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: var(--bg-dark); display: flex; flex-direction: column;
  align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.4s;
}
.loading-overlay.hidden { opacity: 0; pointer-events: none; }
.spinner { width: 44px; height: 44px; border: 3px solid var(--border); border-top-color: var(--orange);
  border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 24px; }
@keyframes spin { to { transform: rotate(360deg); } }
.load-status { font-size: 15px; color: var(--text-muted); font-weight: 500; }
.load-status-sub { font-size: 12px; font-weight: 400; color: var(--text-dim); margin-top: 6px; }
.load-items { margin-top: 16px; font-size: 12px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
.load-items span { padding: 4px 12px; border-radius: 14px; font-weight:500; }
.load-items .ok { background: rgba(74,222,128,0.1); color: var(--positive); }
.load-items .err { background: rgba(248,113,113,0.1); color: var(--negative); }
.load-items .wait { background: var(--bg-input); color: var(--text-dim); }

.error-banner {
  background: rgba(248,113,113,0.06); border: 1px solid rgba(248,113,113,0.15); color: var(--negative);
  padding: 14px 24px; margin: 0 36px 16px; border-radius: 12px; font-size: 12px; display: none;
}
.error-banner.show { display: block; }

@media (max-width: 1100px) {
  .kpi-strip { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 900px) {
  .sidebar { display: none; }
  .main { margin-left: 0; }
  .grid2, .grid3 { grid-template-columns: 1fr; }
  .kpi-strip { grid-template-columns: repeat(2, 1fr); }
  .topbar, .filter-bar, .page-content { padding-left: 18px; padding-right: 18px; }
}
</style>
</head>
<body>

<!-- Loading overlay -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="load-status">Pulling live data from Google Sheets</div>
  <div class="load-status-sub">connecting to era92 data sources...</div>
  <div class="load-items" id="load-items"></div>
</div>

<!-- SIDEBAR -->
<nav class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">e92</div>
    <div>
      <div class="logo-text">era92 Group</div>
      <div class="logo-sub">performance dashboard</div>
    </div>
  </div>
  <div class="sidebar-nav">
    <div class="nav-label">Overview</div>
    <div class="nav-item active" data-tab="overview">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Group Dashboard
    </div>

    <div class="nav-label" style="margin-top:16px">Companies</div>
    <div class="nav-item" data-tab="elevate">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
      era92 Elevate
      <span class="nav-badge">Training</span>
    </div>
    <div class="nav-item" data-tab="creative">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>
      era92 Creative
      <span class="nav-badge">Employment</span>
    </div>
    <div class="nav-item" data-tab="fund">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></svg>
      era92 Fund
      <span class="nav-badge">Finance</span>
    </div>
    <div class="nav-item" data-tab="hub">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      era92 Hub
      <span class="nav-badge">Space</span>
    </div>

    <div class="nav-label" style="margin-top:16px">Data</div>
    <div class="nav-item" data-tab="revenue">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      Revenue Tracker
    </div>
  </div>
  <div class="sidebar-footer">
    <span id="last-updated"></span>
  </div>
</nav>

<!-- MAIN -->
<div class="main">

  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar-left">
      <div>
        <div class="topbar-title" id="topbar-title">Group Dashboard</div>
        <div class="topbar-subtitle" id="topbar-subtitle">era92 group performance overview</div>
      </div>
    </div>
    <div class="topbar-right">
      <div class="currency-toggle">
        <button class="active" onclick="setCurrency('UGX')">UGX</button>
        <button onclick="setCurrency('USD')">USD</button>
      </div>
      <button class="refresh-btn" onclick="location.reload()">Refresh</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-bar">
    <div class="filter-group"><label>Week</label><select id="f-week" onchange="applyFilters()"><option value="">All</option></select></div>
    <div class="filter-group"><label>Quarter</label><select id="f-quarter" onchange="applyFilters()"><option value="">All</option></select></div>
    <div class="filter-group"><label>Year</label><select id="f-year" onchange="applyFilters()"><option value="">All</option></select></div>
    <div class="filter-group"><label>Location</label><select id="f-location" onchange="applyFilters()"><option value="">All</option></select></div>
  </div>

  <!-- Error banner -->
  <div class="error-banner" id="error-banner"></div>

  <!-- ==================== OVERVIEW ==================== -->
  <div class="section active" id="sec-overview">
    <div class="kpi-strip">
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(252,94,39,0.1);color:var(--orange)">$</div>
        <div class="kpi-label">Total Revenue</div>
        <div class="kpi-value" id="k-rev">—</div>
        <div class="kpi-sub" id="k-rev-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(137,214,229,0.1);color:var(--light-blue)">E</div>
        <div class="kpi-label">Students Enrolled</div>
        <div class="kpi-value" id="k-enr">—</div>
        <div class="kpi-sub" id="k-enr-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(38,144,177,0.1);color:var(--dark-blue)">L</div>
        <div class="kpi-label">Loans Disbursed</div>
        <div class="kpi-value" id="k-loan">—</div>
        <div class="kpi-sub" id="k-loan-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(74,222,128,0.1);color:var(--positive)">J</div>
        <div class="kpi-label">Job Placements</div>
        <div class="kpi-value" id="k-plc">—</div>
        <div class="kpi-sub" id="k-plc-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(242,227,219,0.1);color:var(--light-orange)">H</div>
        <div class="kpi-label">Total Hires</div>
        <div class="kpi-value" id="k-hire">—</div>
        <div class="kpi-sub" id="k-hire-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(74,222,128,0.1);color:var(--positive)">%</div>
        <div class="kpi-label">Repayment Rate</div>
        <div class="kpi-value" id="k-rate">—</div>
        <div class="kpi-sub" id="k-rate-alt"></div>
      </div>
    </div>
    <div class="page-content">
      <div class="insight-box" id="ins-overview"><strong>Loading...</strong></div>
      <div class="grid2">
        <div class="card"><h3>Revenue by Brand</h3><canvas id="c-ov-brand"></canvas></div>
        <div class="card"><h3>Weekly Revenue Trend</h3><canvas id="c-ov-revtrend"></canvas></div>
      </div>
      <div class="grid3">
        <div class="card"><h3>Enrollment by Location</h3><canvas id="c-ov-enroll"></canvas></div>
        <div class="card"><h3>Job Placements by Week</h3><canvas id="c-ov-place"></canvas></div>
        <div class="card"><h3>Loans Disbursed (UGX)</h3><canvas id="c-ov-loans"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ==================== ELEVATE ==================== -->
  <div class="section" id="sec-elevate">
    <div class="kpi-strip">
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(137,214,229,0.1);color:var(--light-blue)">S</div>
        <div class="kpi-label">Total Students Reached</div>
        <div class="kpi-value" id="ke-students">—</div>
        <div class="kpi-sub" id="ke-students-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(252,94,39,0.1);color:var(--orange)">$</div>
        <div class="kpi-label">Revenue</div>
        <div class="kpi-value" id="ke-rev">—</div>
        <div class="kpi-sub" id="ke-rev-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(74,222,128,0.1);color:var(--positive)">J</div>
        <div class="kpi-label">Jobs Created</div>
        <div class="kpi-value" id="ke-jobs">—</div>
        <div class="kpi-sub" id="ke-jobs-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(167,139,250,0.1);color:#A78BFA">A</div>
        <div class="kpi-label">Attendance Rate</div>
        <div class="kpi-value" id="ke-attend">—</div>
        <div class="kpi-sub" id="ke-attend-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(74,222,128,0.1);color:var(--positive)">J</div>
        <div class="kpi-label">Job Placements</div>
        <div class="kpi-value" id="ke-placements">—</div>
        <div class="kpi-sub" id="ke-placements-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(38,144,177,0.1);color:var(--dark-blue)">P</div>
        <div class="kpi-label">Employment Partners</div>
        <div class="kpi-value" id="ke-partners">—</div>
        <div class="kpi-sub" id="ke-partners-alt"></div>
      </div>
    </div>
    <div class="page-content">
      <div class="section-header">
        <h2>era92 Elevate</h2>
        <p>training &amp; youth development</p>
      </div>
      <div class="insight-box" id="ins-elevate"><strong>Loading...</strong></div>
      <div class="grid2">
        <div class="card"><h3>Weekly Enrollment by Hub</h3><canvas id="c-el-enroll"></canvas></div>
        <div class="card"><h3>Weekly Admissions by Hub</h3><canvas id="c-el-admit"></canvas></div>
      </div>
      <div class="grid2">
        <div class="card"><h3>Gender Split (Admissions)</h3><canvas id="c-el-gender"></canvas></div>
        <div class="card"><h3>Refugee Enrollment</h3><canvas id="c-el-refugee"></canvas></div>
      </div>
      <div class="grid2">
        <div class="card"><h3>Students by Year (All Time)</h3><canvas id="c-el-employed"></canvas></div>
        <div class="card"><h3>Students by Course (Top 8)</h3><canvas id="c-el-active"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ==================== CREATIVE ==================== -->
  <div class="section" id="sec-creative">
    <div class="kpi-strip">
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(252,94,39,0.1);color:var(--orange)">$</div>
        <div class="kpi-label">Revenue</div>
        <div class="kpi-value" id="kc-rev">—</div>
        <div class="kpi-sub" id="kc-rev-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(137,214,229,0.1);color:var(--light-blue)">R</div>
        <div class="kpi-label">Number of Retainers</div>
        <div class="kpi-value" id="kc-retainers">—</div>
        <div class="kpi-sub" id="kc-retainers-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(74,222,128,0.1);color:var(--positive)">A</div>
        <div class="kpi-label">Avg Retainer Value</div>
        <div class="kpi-value" id="kc-avgretainer">—</div>
        <div class="kpi-sub" id="kc-avgretainer-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(38,144,177,0.1);color:var(--dark-blue)">I</div>
        <div class="kpi-label">Income Earned</div>
        <div class="kpi-value" id="kc-income">—</div>
        <div class="kpi-sub" id="kc-income-alt"></div>
      </div>
    </div>
    <div class="page-content">
      <div class="section-header">
        <h2>era92 Creative</h2>
        <p>employment &amp; workforce development</p>
      </div>
      <div class="insight-box" id="ins-creative"><strong>Loading...</strong></div>
      <div class="grid2">
        <div class="card"><h3>New Placements by Week</h3><canvas id="c-cr-place"></canvas></div>
        <div class="card"><h3>Income Earned (Weekly)</h3><canvas id="c-cr-income"></canvas></div>
      </div>
      <div class="grid2">
        <div class="card"><h3>Active Projects</h3><canvas id="c-cr-proj"></canvas></div>
        <div class="card"><h3>Interviews Completed</h3><canvas id="c-cr-intv"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ==================== FUND ==================== -->
  <div class="section" id="sec-fund">
    <div class="kpi-strip">
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(38,144,177,0.1);color:var(--dark-blue)">L</div>
        <div class="kpi-label">Total Loans Disbursed</div>
        <div class="kpi-value" id="kf-loans">—</div>
        <div class="kpi-sub" id="kf-loans-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(74,222,128,0.1);color:var(--positive)">%</div>
        <div class="kpi-label">Repayment Rate</div>
        <div class="kpi-value" id="kf-rate">—</div>
        <div class="kpi-sub" id="kf-rate-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(252,94,39,0.1);color:var(--orange)">Y</div>
        <div class="kpi-label">This Year's Loans Disbursed</div>
        <div class="kpi-value" id="kf-thisyear">—</div>
        <div class="kpi-sub" id="kf-thisyear-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(137,214,229,0.1);color:var(--light-blue)">A</div>
        <div class="kpi-label">Average Loan Size</div>
        <div class="kpi-value" id="kf-avg">—</div>
        <div class="kpi-sub" id="kf-avg-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(242,227,219,0.1);color:var(--light-orange)">B</div>
        <div class="kpi-label">Total Borrowers</div>
        <div class="kpi-value" id="kf-borrowers">—</div>
        <div class="kpi-sub" id="kf-borrowers-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(74,222,128,0.1);color:var(--positive)">$</div>
        <div class="kpi-label">Fund Revenue</div>
        <div class="kpi-value" id="kf-revenue">—</div>
        <div class="kpi-sub" id="kf-revenue-alt"></div>
      </div>
    </div>
    <div class="page-content">
      <div class="section-header">
        <h2>era92 Fund</h2>
        <p>microfinance &amp; financial inclusion</p>
      </div>
      <div class="insight-box" id="ins-fund"><strong>Loading...</strong></div>
      <div class="grid2">
        <div class="card"><h3>Amount Disbursed by Week (UGX)</h3><canvas id="c-mf-disb"></canvas></div>
        <div class="card"><h3>Repayment Rate (%)</h3><canvas id="c-mf-rate"></canvas></div>
      </div>
      <div class="grid2">
        <div class="card"><h3>Loans at Risk (30+ days)</h3><canvas id="c-mf-risk"></canvas></div>
        <div class="card"><h3>Collection Goal vs Actual Collected</h3><canvas id="c-mf-goalvscoll"></canvas></div>
      </div>
      <div class="grid2">
        <div class="card"><h3>Disbursed vs Collected</h3><canvas id="c-mf-coll"></canvas></div>
        <div class="card"><h3>Fund Revenue (from Revenue Tracker)</h3><canvas id="c-mf-fundrev"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ==================== HUB ==================== -->
  <div class="section" id="sec-hub">
    <div class="kpi-strip">
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(252,94,39,0.1);color:var(--orange)">$</div>
        <div class="kpi-label">Revenue</div>
        <div class="kpi-value" id="kh-rev">—</div>
        <div class="kpi-sub" id="kh-rev-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(137,214,229,0.1);color:var(--light-blue)">E</div>
        <div class="kpi-label">Events Hosted</div>
        <div class="kpi-value" id="kh-events">—</div>
        <div class="kpi-sub" id="kh-events-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(38,144,177,0.1);color:var(--dark-blue)">C</div>
        <div class="kpi-label">Active Clients</div>
        <div class="kpi-value" id="kh-clients">—</div>
        <div class="kpi-sub" id="kh-clients-alt"></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(74,222,128,0.1);color:var(--positive)">P</div>
        <div class="kpi-label">Partnerships</div>
        <div class="kpi-value" id="kh-partners">—</div>
        <div class="kpi-sub" id="kh-partners-alt"></div>
      </div>
    </div>
    <div class="page-content">
      <div class="section-header">
        <h2>era92 Hub</h2>
        <p>co-working space &amp; community</p>
      </div>
      <div class="insight-box" id="ins-hub"><strong>Loading...</strong></div>
      <div class="grid2">
        <div class="card"><h3>Hub Revenue by Week</h3><canvas id="c-hb-rev"></canvas></div>
        <div class="card"><h3>Events & Partnerships</h3><canvas id="c-hb-evt"></canvas></div>
      </div>
      <div class="grid2">
        <div class="card"><h3>Prospects & Foot Traffic</h3><canvas id="c-hb-pros"></canvas></div>
        <div class="card"><h3>Active Clients & Bookings</h3><canvas id="c-hb-cli"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ==================== REVENUE ==================== -->
  <div class="section" id="sec-revenue">
    <div class="kpi-strip">
      <div class="kpi-card">
        <div class="kpi-icon" style="background:rgba(252,94,39,0.1);color:var(--orange)">$</div>
        <div class="kpi-label">Total Group Revenue</div>
        <div class="kpi-value" id="kr-total">—</div>
        <div class="kpi-sub" id="kr-total-alt"></div>
      </div>
    </div>
    <div class="page-content">
      <div class="section-header">
        <h2>Revenue Tracker</h2>
        <p>consolidated revenue across all brands</p>
      </div>
      <div class="insight-box" id="ins-revenue"><strong>Loading...</strong></div>
      <div class="grid2">
        <div class="card"><h3>Revenue by Brand</h3><canvas id="c-rv-bar"></canvas></div>
        <div class="card"><h3>Revenue Share</h3><canvas id="c-rv-donut"></canvas></div>
      </div>
      <div class="grid2">
        <div class="card full"><h3>Weekly Revenue Trend by Brand</h3><canvas id="c-rv-trend"></canvas></div>
      </div>
    </div>
  </div>

</div>

<script>
/* ==================================================
   era92 Group Live Dashboard — Dark Theme v2
   Inter Tight + Instrument Serif
   Dual Currency (UGX / USD)
   ================================================== */

/* Chart.js dark theme */
Chart.defaults.color = '#9d9a94';
Chart.defaults.borderColor = '#3a3b42';
Chart.defaults.font.family = "'Inter Tight', system-ui, sans-serif";
Chart.defaults.font.weight = 500;
Chart.defaults.plugins.legend.labels.color = '#9d9a94';

var COLORS = ['#FC5E27','#89D6E5','#2690B1','#F2E3DB','#4ADE80','#A78BFA','#F87171','#FBBF24'];
var BRAND_COLORS = {'92 Cafe':'#FC5E27','92 CarWash':'#89D6E5','era92 Hub':'#2690B1','era92 Creative':'#A78BFA','era92 Elevate':'#F2E3DB','era92 Finance':'#4ADE80'};
var LOC_COLORS = {'Lungujja':'#FC5E27','Katanga':'#89D6E5','Jinja':'#4ADE80','Namayemba':'#A78BFA'};

var KPI_ID = '1fch4Cy5sj1VQ_iaD2NK0SoOE1EKjsr_7YmZSUt3-ngU';
var REV_ID = '1n4eFTqFmyvm9xEY-meoio2v6qFoCow7mwC6BU0wNAhI';
var ALLTIME_ID = '1m7xnMfXTRID7bUi3tO4Q7v3LpPwXRntz3hQQ6zOuhtQ';
var FUND_AT_ID = '1wP9nQA9-gO8LWZh0kGP48cxYJ__MpWFBmApuQhrECzU';
var RETAINER_ID = '15FV8X-czVT1AGWJAX3l7a-BGf2mpcYFlY0QAdJKho4M';

var DATA = {}, FDATA = {}, CHARTS = {}, ERRORS = [];
var CURRENCY = 'UGX';
var FX_RATE = 3500;

/* ---- Currency ---- */
function setCurrency(c) {
  CURRENCY = c;
  document.querySelectorAll('.currency-toggle button').forEach(function(b) {
    b.classList.toggle('active', b.textContent === c);
  });
  renderAll();
}

/* ---- Sidebar nav ---- */
var TAB_INFO = {
  overview:  { title:'Group Dashboard', sub:'era92 group performance overview' },
  elevate:   { title:'era92 Elevate',   sub:'training & youth development' },
  creative:  { title:'era92 Creative',  sub:'employment & workforce development' },
  fund:      { title:'era92 Fund',      sub:'microfinance & financial inclusion' },
  hub:       { title:'era92 Hub',       sub:'co-working space & community' },
  revenue:   { title:'Revenue Tracker', sub:'consolidated revenue across all brands' }
};

document.querySelector('.sidebar-nav').addEventListener('click', function(e) {
  var item = e.target.closest('.nav-item');
  if (!item) return;
  document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
  document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
  item.classList.add('active');
  var tab = item.getAttribute('data-tab');
  var sec = document.getElementById('sec-' + tab);
  if (sec) sec.classList.add('active');
  var info = TAB_INFO[tab] || {};
  document.getElementById('topbar-title').textContent = info.title || tab;
  document.getElementById('topbar-subtitle').textContent = info.sub || '';
});

/* ---- Query Google Sheet via Visualization API ---- */
function queryGSheet(sheetId, tabName) {
  return new Promise(function(resolve, reject) {
    try {
      var url = 'https://docs.google.com/spreadsheets/d/' + sheetId + '/gviz/tq?sheet=' + encodeURIComponent(tabName);
      var q = new google.visualization.Query(url);
      q.setTimeout(20);
      q.send(function(resp) {
        try {
          if (resp.isError()) { reject(new Error(resp.getMessage())); return; }
          var t = resp.getDataTable();
          var nc = t.getNumberOfColumns(), nr = t.getNumberOfRows();
          var hdrs = [];
          for (var c = 0; c < nc; c++) hdrs.push(t.getColumnLabel(c) || t.getColumnId(c));
          var rows = [];
          for (var r = 0; r < nr; r++) {
            var obj = {}, hasVal = false;
            for (var c2 = 0; c2 < nc; c2++) {
              var v = t.getValue(r, c2);
              obj[hdrs[c2]] = v;
              if (v !== null && v !== undefined && v !== '') hasVal = true;
            }
            if (hasVal) rows.push(obj);
          }
          resolve({ headers: hdrs, rows: rows });
        } catch (e) { reject(e); }
      });
    } catch (e) { reject(e); }
  });
}

function queryRevenue() {
  return new Promise(function(resolve, reject) {
    try {
      var url = 'https://docs.google.com/spreadsheets/d/' + REV_ID + '/gviz/tq?sheet=Sheet1';
      var q = new google.visualization.Query(url);
      q.setTimeout(20);
      q.send(function(resp) {
        try {
          if (resp.isError()) { reject(new Error(resp.getMessage())); return; }
          var t = resp.getDataTable();
          var nr = t.getNumberOfRows(), nc = t.getNumberOfColumns();
          var COLS = { Dates:0, Week:1, Quarter:2, Year:3, Enterprise:4, Revenue:5, NewDonors:7 };
          var rows = [];
          for (var r = 0; r < nr; r++) {
            var enterprise = t.getValue(r, COLS.Enterprise);
            var revenue = t.getValue(r, COLS.Revenue);
            if (!enterprise || typeof enterprise !== 'string') continue;
            if (enterprise.toLowerCase().includes('total') || enterprise.toLowerCase().includes('enterprise')) continue;
            rows.push({
              Dates: t.getValue(r, COLS.Dates),
              Week: t.getValue(r, COLS.Week),
              Quarter: t.getValue(r, COLS.Quarter),
              Year: t.getValue(r, COLS.Year),
              Enterprise: enterprise.trim(),
              Revenue: typeof revenue === 'number' ? revenue : parseFloat(String(revenue).replace(/,/g,'')) || 0,
              NewDonors: t.getValue(r, COLS.NewDonors)
            });
          }
          resolve({ headers: ['Dates','Week','Quarter','Year','Enterprise','Revenue','NewDonors'], rows: rows });
        } catch (e) { reject(e); }
      });
    } catch (e) { reject(e); }
  });
}

/* ---- Utilities ---- */
function N(v) { return typeof v === 'number' ? v : parseFloat(v) || 0; }

function fmtMoney(v) {
  v = N(v);
  if (CURRENCY === 'USD') v = v / FX_RATE;
  var prefix = CURRENCY === 'USD' ? '$' : 'UGX ';
  if (CURRENCY === 'USD') {
    if (v >= 1e6) return prefix + (v/1e6).toFixed(1) + 'M';
    if (v >= 1e3) return prefix + (v/1e3).toFixed(1) + 'K';
    return prefix + Math.round(v).toLocaleString();
  }
  if (v >= 1e9) return prefix + (v/1e9).toFixed(1) + 'B';
  if (v >= 1e6) return prefix + (v/1e6).toFixed(1) + 'M';
  if (v >= 1e3) return prefix + (v/1e3).toFixed(0) + 'K';
  return prefix + Math.round(v).toLocaleString();
}

function fmtMoneyAlt(v) {
  v = N(v);
  var otherCur = CURRENCY === 'UGX' ? 'USD' : 'UGX';
  var cv = CURRENCY === 'UGX' ? v / FX_RATE : v * FX_RATE;
  var prefix = otherCur === 'USD' ? '≈ $' : '≈ UGX ';
  if (otherCur === 'USD') {
    if (cv >= 1e6) return prefix + (cv/1e6).toFixed(1) + 'M';
    if (cv >= 1e3) return prefix + (cv/1e3).toFixed(1) + 'K';
    return prefix + Math.round(cv).toLocaleString();
  }
  if (cv >= 1e9) return prefix + (cv/1e9).toFixed(1) + 'B';
  if (cv >= 1e6) return prefix + (cv/1e6).toFixed(1) + 'M';
  return prefix + (cv/1e3).toFixed(0) + 'K';
}

function fmtN(v) { v = N(v); if (v >= 1e6) return (v/1e6).toFixed(1)+'M'; if (v >= 1e3) return (v/1e3).toFixed(1)+'K'; return Math.round(v).toLocaleString(); }
function sum(rows, col) { return rows.reduce(function(s,r){ return s + N(r[col]); }, 0); }
function col(hdrs) {
  var args = Array.prototype.slice.call(arguments, 1);
  for (var i = 0; i < args.length; i++) {
    var kw = args[i].toLowerCase();
    var m = hdrs.find(function(h){ return h && h.toLowerCase().indexOf(kw) >= 0; });
    if (m) return m;
  }
  return null;
}

function byWeek(rows, weekCol) {
  var g = {};
  rows.forEach(function(r) {
    var w = N(r[weekCol]);
    if (!w) return;
    if (!g[w]) g[w] = [];
    g[w].push(r);
  });
  var weeks = Object.keys(g).map(Number).sort(function(a,b){return a-b;});
  return { weeks: weeks, groups: g };
}

/* ---- Chart factory (dark themed) ---- */
function mk(id, type, labels, datasets, opts) {
  if (CHARTS[id]) CHARTS[id].destroy();
  var el = document.getElementById(id);
  if (!el) return;
  var isDoughnut = type==='doughnut'||type==='pie';
  var base = {
    responsive: true, maintainAspectRatio: false, animation: false,
    plugins: {
      legend: { position:'top', labels: { usePointStyle:true, padding:14, font:{size:11, weight:500} } },
      tooltip: { backgroundColor:'#292a30', titleColor:'#f0ece8', bodyColor:'#9d9a94', borderColor:'#3a3b42', borderWidth:1, cornerRadius:10, padding:12, titleFont:{weight:700} }
    },
    scales: isDoughnut ? {} : {
      x:{ grid:{display:false}, ticks:{color:'#6b6862', font:{size:11}} },
      y:{ beginAtZero:true, grid:{color:'#2a2b31'}, ticks:{color:'#6b6862', font:{size:11}} }
    }
  };
  var o = Object.assign({}, base, opts || {});
  CHARTS[id] = new Chart(el, { type:type, data:{labels:labels, datasets:datasets}, options:o });
}

function mkLine(id, labels, series) {
  mk(id, 'line', labels, series.map(function(s,i){
    var c = s.color||COLORS[i%COLORS.length];
    return { label:s.label, data:s.data, borderColor:c, backgroundColor:c+'20', borderWidth:2, fill:true, tension:0.35, pointRadius:4, pointHoverRadius:6, pointBackgroundColor:'#292a30', pointBorderColor:c, pointBorderWidth:2 };
  }));
}
function mkBar(id, labels, series, stacked) {
  var ds = series.map(function(s,i){ return { label:s.label, data:s.data, backgroundColor:(s.color||COLORS[i%COLORS.length])+'B3', hoverBackgroundColor:(s.color||COLORS[i%COLORS.length])+'E6', borderRadius:6, borderSkipped:false, maxBarThickness:48 }; });
  var opts = stacked ? { scales:{x:{stacked:true,grid:{display:false},ticks:{color:'#6b6862',font:{size:11}}},y:{stacked:true,beginAtZero:true,grid:{color:'#2a2b31'},ticks:{color:'#6b6862',font:{size:11}}}} } : undefined;
  mk(id, 'bar', labels, ds, opts);
}
function mkDonut(id, labels, data) {
  mk(id, 'doughnut', labels, [{ data:data, backgroundColor:labels.map(function(l,i){ return (BRAND_COLORS[l]||COLORS[i%COLORS.length])+'CC'; }), borderWidth:2, borderColor:'#292a30' }], { cutout:'62%' });
}

/* ==== FILTERS ==== */
function applyFilters() {
  var fw = document.getElementById('f-week').value;
  var fq = document.getElementById('f-quarter').value;
  var fy = document.getElementById('f-year').value;
  var fl = document.getElementById('f-location').value;

  Object.keys(DATA).forEach(function(name) {
    var sheet = DATA[name];
    if (!sheet || !sheet.rows) { FDATA[name] = sheet; return; }
    var h = sheet.headers;
    var wc = col(h,'Week'), qc = col(h,'Quarter'), yc = col(h,'Year');
    var lc = col(h,'Hub Location','Location','Branch');
    FDATA[name] = {
      headers: h,
      rows: sheet.rows.filter(function(r) {
        if (fw && wc && N(r[wc]) !== N(fw)) return false;
        if (fq && qc && String(N(r[qc])) !== fq) return false;
        if (fy && yc && String(N(r[yc])) !== fy) return false;
        if (fl && lc && String(r[lc]) !== fl) return false;
        return true;
      })
    };
  });
  renderAll();
}

function populateFilters() {
  var weeks = new Set(), quarters = new Set(), years = new Set(), locations = new Set();
  Object.values(DATA).forEach(function(s) {
    if (!s || !s.rows) return;
    s.rows.forEach(function(r) {
      var wc = col(s.headers,'Week'); if (wc && N(r[wc])) weeks.add(N(r[wc]));
      var qc = col(s.headers,'Quarter'); if (qc && r[qc]) quarters.add(String(N(r[qc])));
      var yc = col(s.headers,'Year'); if (yc && r[yc]) years.add(String(N(r[yc])));
      var lc = col(s.headers,'Hub Location','Location','Branch'); if (lc && r[lc]) locations.add(String(r[lc]));
    });
  });
  function fill(selId, vals, prefix) {
    var sel = document.getElementById(selId);
    Array.from(vals).sort(function(a,b){ return N(a)-N(b)||String(a).localeCompare(String(b)); }).forEach(function(v) {
      if (!v || v==='NaN') return;
      var o = document.createElement('option'); o.value = v; o.textContent = (prefix||'') + v; sel.appendChild(o);
    });
  }
  fill('f-week', weeks, 'Week '); fill('f-quarter', quarters, 'Q'); fill('f-year', years, '');
  fill('f-location', locations, '');
}

/* ==== RENDER ALL ==== */
function renderAll() {
  try { renderOverviewKPIs(); } catch(e) { console.warn('KPI:', e); }
  try { renderOverview(); } catch(e) { console.warn('Overview:', e); }
  try { renderElevate(); } catch(e) { console.warn('Elevate:', e); }
  try { renderCreative(); } catch(e) { console.warn('Creative:', e); }
  try { renderFund(); } catch(e) { console.warn('Fund:', e); }
  try { renderHub(); } catch(e) { console.warn('Hub:', e); }
  try { renderRevenue(); } catch(e) { console.warn('Revenue:', e); }
}

/* ==== OVERVIEW KPIs ==== */
function renderOverviewKPIs() {
  var rv = FDATA.Revenue;
  if (rv && rv.rows.length) {
    var total = sum(rv.rows, 'Revenue');
    document.getElementById('k-rev').textContent = fmtMoney(total);
    document.getElementById('k-rev-alt').textContent = fmtMoneyAlt(total);
  }

  var el = FDATA.Elevate;
  if (el && el.rows.length) {
    var ec = col(el.headers, 'enrolled');
    if (ec) {
      var v = sum(el.rows, ec);
      document.getElementById('k-enr').textContent = fmtN(v);
      document.getElementById('k-enr-alt').textContent = 'across all hubs';
    }
  }

  var mf = FDATA.Microfinance;
  if (mf && mf.rows.length) {
    var lc = col(mf.headers, 'Total Loans Disbursed this week');
    if (lc) {
      var lv = sum(mf.rows, lc);
      document.getElementById('k-loan').textContent = fmtMoney(lv);
      document.getElementById('k-loan-alt').textContent = fmtMoneyAlt(lv);
    }
    var ratec = col(mf.headers, 'Repayment rate');
    if (ratec) {
      var vals = mf.rows.map(function(r){ return N(r[ratec]); }).filter(function(v){ return v > 0; });
      var avg = vals.length ? vals.reduce(function(s,v){return s+v;},0)/vals.length : 0;
      document.getElementById('k-rate').textContent = avg.toFixed(1) + '%';
      document.getElementById('k-rate-alt').textContent = 'avg weekly rate';
    }
  }

  var em = FDATA.Employment;
  if (em && em.rows.length) {
    var pc = col(em.headers, 'New placements');
    if (pc) {
      document.getElementById('k-plc').textContent = fmtN(sum(em.rows, pc));
      document.getElementById('k-plc-alt').textContent = 'era92 Creative';
    }
  }

  var gr = FDATA['era92 Group'];
  if (gr && gr.rows.length) {
    var hc = col(gr.headers, 'Hires');
    if (hc) {
      document.getElementById('k-hire').textContent = fmtN(sum(gr.rows, hc));
      document.getElementById('k-hire-alt').textContent = 'group-wide';
    }
  }
}

/* ==== OVERVIEW CHARTS ==== */
function renderOverview() {
  var rv = FDATA.Revenue;
  if (rv && rv.rows.length) {
    var bb = {};
    rv.rows.forEach(function(r) { bb[r.Enterprise] = (bb[r.Enterprise]||0) + N(r.Revenue); });
    var brands = Object.keys(bb).sort(function(a,b){ return bb[b]-bb[a]; });
    mkBar('c-ov-brand', brands, [{ label:'Revenue', data:brands.map(function(b){return bb[b];}) }]);
    var wk = col(rv.headers, 'Week');
    if (wk) {
      var bw = byWeek(rv.rows, wk);
      mkLine('c-ov-revtrend', bw.weeks.map(function(w){return 'W'+w;}), [{ label:'Total Revenue', data:bw.weeks.map(function(w){ return sum(bw.groups[w],'Revenue'); }), color:'#FC5E27' }]);
    }
  }
  var el = FDATA.Elevate;
  if (el && el.rows.length) {
    var wc = col(el.headers, 'Week'), ec = col(el.headers, 'enrolled'), lc2 = col(el.headers, 'Hub Location');
    if (wc && ec) {
      var bw2 = byWeek(el.rows, wc);
      var wl2 = bw2.weeks.map(function(w){return 'W'+w;});
      if (lc2) {
        mkBar('c-ov-enroll', wl2, ['Lungujja','Katanga','Jinja','Namayemba'].map(function(loc){
          return { label:loc, data:bw2.weeks.map(function(w){ return sum(bw2.groups[w].filter(function(r){return r[lc2]===loc;}), ec); }), color:LOC_COLORS[loc] };
        }), true);
      } else {
        mkBar('c-ov-enroll', wl2, [{ label:'Enrollments', data:bw2.weeks.map(function(w){ return sum(bw2.groups[w], ec); }) }]);
      }
    }
  }
  var em = FDATA.Employment;
  if (em && em.rows.length) {
    var wc3 = col(em.headers, 'Week'), pc = col(em.headers, 'New placements');
    if (wc3 && pc) {
      var bw3 = byWeek(em.rows, wc3);
      mkBar('c-ov-place', bw3.weeks.map(function(w){return 'W'+w;}), [{ label:'Placements', data:bw3.weeks.map(function(w){ return sum(bw3.groups[w], pc); }), color:'#4ADE80' }]);
    }
  }
  var mf = FDATA.Microfinance;
  if (mf && mf.rows.length) {
    var wc4 = col(mf.headers, 'Week'), dc = col(mf.headers, 'Total Loans Disbursed this week');
    if (wc4 && dc) {
      var bw4 = byWeek(mf.rows, wc4);
      mkBar('c-ov-loans', bw4.weeks.map(function(w){return 'W'+w;}), [{ label:'Disbursed', data:bw4.weeks.map(function(w){ return sum(bw4.groups[w], dc); }), color:'#89D6E5' }]);
    }
  }
  var loaded = Object.keys(FDATA).filter(function(k){ return FDATA[k] && FDATA[k].rows && FDATA[k].rows.length > 0; });
  document.getElementById('ins-overview').innerHTML = '<strong>Group Overview</strong> — Live data from ' + loaded.length + ' sources. Use sidebar to dive into each company, or filters to narrow by week, quarter, or location.';
}

/* ==== ELEVATE ==== */
function renderElevate() {
  var el = FDATA.Elevate;
  if (!el || !el.rows.length) return;
  var h = el.headers, wc = col(h,'Week'), lc = col(h,'Hub Location');
  var ec = col(h,'enrolled'), ac = col(h,'admitted'), mc = col(h,'Male'), fc = col(h,'Female'), rc = col(h,'Refugee');
  var empc = col(h,'employed'), activec = col(h,'active trainees'), attendc = col(h, 'attendance rate');

  // Use all-time data if available for KPIs
  var at = FDATA.AllTime;
  var allTimeTotal = 0, allTimeGraduated = 0;
  if (at && at.rows && at.rows.length) {
    allTimeTotal = at.rows.length;
    var statusCol = col(at.headers, 'Status');
    if (statusCol) {
      allTimeGraduated = at.rows.filter(function(r){ return r[statusCol] && String(r[statusCol]).toLowerCase() === 'graduated'; }).length;
    }
    document.getElementById('ke-students').textContent = fmtN(allTimeTotal);
    document.getElementById('ke-students-alt').textContent = allTimeGraduated + ' graduated, ' + (allTimeTotal - allTimeGraduated) + ' active';
  } else {
    var totalStudents = ec ? sum(el.rows, ec) : 0;
    document.getElementById('ke-students').textContent = fmtN(totalStudents);
    document.getElementById('ke-students-alt').textContent = 'weekly enrolled';
  }

  // Revenue from Revenue sheet for Elevate brand
  var rv = FDATA.Revenue;
  if (rv && rv.rows.length) {
    var elevateRev = rv.rows.filter(function(r){ return r.Enterprise && r.Enterprise.toLowerCase().includes('elevate'); });
    var revTotal = sum(elevateRev, 'Revenue');
    document.getElementById('ke-rev').textContent = fmtMoney(revTotal);
    document.getElementById('ke-rev-alt').textContent = fmtMoneyAlt(revTotal);
  }

  var jobsCreated = empc ? sum(el.rows, empc) : 0;
  // If all-time data available, use graduated count as proxy for jobs created
  if (at && at.rows && allTimeGraduated > 0) {
    document.getElementById('ke-jobs').textContent = fmtN(allTimeGraduated);
    document.getElementById('ke-jobs-alt').textContent = 'graduated & job-ready';
  } else {
    document.getElementById('ke-jobs').textContent = fmtN(jobsCreated);
    document.getElementById('ke-jobs-alt').textContent = 'graduates employed';
  }

  if (attendc) {
    var aVals = el.rows.map(function(r){ return N(r[attendc]); }).filter(function(v){ return v > 0; });
    var avgA = aVals.length ? aVals.reduce(function(s,v){return s+v;},0)/aVals.length : 0;
    document.getElementById('ke-attend').textContent = avgA.toFixed(0) + '%';
    document.getElementById('ke-attend-alt').textContent = 'avg weekly';
  }

  // Job Placements & Employment Partners (from Employment sheet)
  var em2 = FDATA.Employment;
  if (em2 && em2.rows.length) {
    var pc2 = col(em2.headers, 'New placements');
    var clientsc2 = col(em2.headers, 'clients served');
    if (pc2) {
      document.getElementById('ke-placements').textContent = fmtN(sum(em2.rows, pc2));
      document.getElementById('ke-placements-alt').textContent = 'from era92 Creative';
    }
    if (clientsc2) {
      document.getElementById('ke-partners').textContent = fmtN(sum(em2.rows, clientsc2));
      document.getElementById('ke-partners-alt').textContent = 'clients served';
    }
  }

  if (!wc) return;
  var bw = byWeek(el.rows, wc), wl = bw.weeks.map(function(w){return 'W'+w;});
  var locs = ['Lungujja','Katanga','Jinja','Namayemba'];
  if (ec && lc) mkBar('c-el-enroll', wl, locs.map(function(loc){ return { label:loc, data:bw.weeks.map(function(w){ return sum(bw.groups[w].filter(function(r){return r[lc]===loc;}), ec); }), color:LOC_COLORS[loc] }; }), true);
  if (ac && lc) mkBar('c-el-admit', wl, locs.map(function(loc){ return { label:loc, data:bw.weeks.map(function(w){ return sum(bw.groups[w].filter(function(r){return r[lc]===loc;}), ac); }), color:LOC_COLORS[loc] }; }), true);
  if (mc && fc) mkBar('c-el-gender', wl, [
    { label:'Male', data:bw.weeks.map(function(w){ return sum(bw.groups[w], mc); }), color:'#89D6E5' },
    { label:'Female', data:bw.weeks.map(function(w){ return sum(bw.groups[w], fc); }), color:'#FC5E27' }
  ], true);
  if (rc) mkBar('c-el-refugee', wl, [{ label:'Refugees', data:bw.weeks.map(function(w){ return sum(bw.groups[w], rc); }), color:'#A78BFA' }]);

  // All-time charts: Students by Year and by Course
  if (at && at.rows && at.rows.length) {
    var yearCol = col(at.headers, 'Year'), courseCol = col(at.headers, 'Course');
    if (yearCol) {
      var byYr = {};
      at.rows.forEach(function(r) { var y = r[yearCol]; if(y) { byYr[y] = (byYr[y]||0)+1; } });
      var yrs = Object.keys(byYr).sort();
      mkBar('c-el-employed', yrs, [{ label:'Students per Year', data:yrs.map(function(y){return byYr[y];}), color:'#4ADE80' }]);
    }
    if (courseCol) {
      var byCourse = {};
      at.rows.forEach(function(r) { var c = r[courseCol]; if(c) { byCourse[c] = (byCourse[c]||0)+1; } });
      var courses = Object.keys(byCourse).sort(function(a,b){return byCourse[b]-byCourse[a];}).slice(0,8);
      mkBar('c-el-active', courses, [{ label:'Students', data:courses.map(function(c){return byCourse[c];}), color:'#89D6E5' }]);
    }
  } else {
    if (empc) mkBar('c-el-employed', wl, [{ label:'Employed', data:bw.weeks.map(function(w){ return sum(bw.groups[w], empc); }), color:'#4ADE80' }]);
    if (activec) mkLine('c-el-active', wl, [{ label:'Active Trainees', data:bw.weeks.map(function(w){ return sum(bw.groups[w], activec); }), color:'#89D6E5' }]);
  }

  var totalDisp = at && at.rows ? fmtN(allTimeTotal) : fmtN(ec ? sum(el.rows, ec) : 0);
  document.getElementById('ins-elevate').innerHTML = '<strong>Elevate</strong> — ' + totalDisp + ' total students reached since 2019, ' + fmtN(allTimeGraduated) + ' graduated across ' + locs.length + ' hubs.';
}

/* ==== CREATIVE (Employment) ==== */
function renderCreative() {
  var em = FDATA.Employment;
  if (!em || !em.rows.length) return;
  var h = em.headers, wc = col(h,'Week');
  var pc = col(h,'New placements'), ic = col(h,'income earned'), prc = col(h,'active projects'), intc = col(h,'interviews completed');
  var clientsc = col(h,'clients served');

  // KPIs
  var rv = FDATA.Revenue;
  if (rv && rv.rows.length) {
    var creativeRev = rv.rows.filter(function(r){ return r.Enterprise && r.Enterprise.toLowerCase().includes('creative'); });
    var revTotal = sum(creativeRev, 'Revenue');
    document.getElementById('kc-rev').textContent = fmtMoney(revTotal);
    document.getElementById('kc-rev-alt').textContent = fmtMoneyAlt(revTotal);
  }

  // Retainer KPIs from Retainer sheet
  var ret = FDATA.Retainers;
  if (ret && ret.rows && ret.rows.length) {
    var priceCol = col(ret.headers, 'Price');
    var statusCol = col(ret.headers, 'Status');
    var totalRetainers = ret.rows.length;
    document.getElementById('kc-retainers').textContent = fmtN(totalRetainers);
    var happyCount = statusCol ? ret.rows.filter(function(r){ return r[statusCol] && String(r[statusCol]).toLowerCase().indexOf('happy') >= 0; }).length : 0;
    var newCount = statusCol ? ret.rows.filter(function(r){ return r[statusCol] && String(r[statusCol]).toLowerCase().indexOf('new') >= 0; }).length : 0;
    document.getElementById('kc-retainers-alt').textContent = happyCount + ' happy, ' + newCount + ' new';
    if (priceCol) {
      var prices = ret.rows.map(function(r){ return N(r[priceCol]); }).filter(function(v){ return v > 0; });
      var avgRetainer = prices.length ? prices.reduce(function(s,v){return s+v;},0)/prices.length : 0;
      // Retainer prices are in USD in the sheet
      if (CURRENCY === 'UGX') {
        document.getElementById('kc-avgretainer').textContent = 'UGX ' + fmtN(avgRetainer * FX_RATE);
        document.getElementById('kc-avgretainer-alt').textContent = '≈ $' + Math.round(avgRetainer).toLocaleString();
      } else {
        document.getElementById('kc-avgretainer').textContent = '$' + Math.round(avgRetainer).toLocaleString();
        document.getElementById('kc-avgretainer-alt').textContent = '≈ UGX ' + fmtN(avgRetainer * FX_RATE);
      }
    }
  }

  var totalIncome = ic ? sum(em.rows, ic) : 0;
  document.getElementById('kc-income').textContent = fmtMoney(totalIncome);
  document.getElementById('kc-income-alt').textContent = fmtMoneyAlt(totalIncome);

  if (!wc) return;
  var bw = byWeek(em.rows, wc), wl = bw.weeks.map(function(w){return 'W'+w;});
  if (pc) mkBar('c-cr-place', wl, [{ label:'New Placements', data:bw.weeks.map(function(w){ return sum(bw.groups[w], pc); }), color:'#4ADE80' }]);
  if (ic) mkLine('c-cr-income', wl, [{ label:'Income Earned', data:bw.weeks.map(function(w){ return sum(bw.groups[w], ic); }), color:'#89D6E5' }]);
  if (prc) mkLine('c-cr-proj', wl, [{ label:'Active Projects', data:bw.weeks.map(function(w){ return sum(bw.groups[w], prc); }), color:'#2690B1' }]);
  if (intc) mkBar('c-cr-intv', wl, [{ label:'Interviews', data:bw.weeks.map(function(w){ return sum(bw.groups[w], intc); }), color:'#FBBF24' }]);

  var retainerCount = (ret && ret.rows) ? ret.rows.length : 0;
  document.getElementById('ins-creative').innerHTML = '<strong>Creative</strong> — ' + retainerCount + ' active retainer clients, ' + fmtMoney(totalIncome) + ' income earned. Revenue: ' + document.getElementById('kc-rev').textContent + '.';
}

/* ==== FUND (Microfinance) ==== */
function renderFund() {
  var mf = FDATA.Microfinance;
  if (!mf || !mf.rows.length) return;
  var h = mf.headers, wc = col(h,'Week'), yrc = col(h,'Year');
  var dc = col(h,'Total Amount Disbursed this week','Total Loans Disbursed this week');
  var ratec = col(h,'Repayment rate'), riskc = col(h,'loans at risk');
  var collc = col(h,'Actual Weekly repayment','Actual Weekly repayment collected');
  var goalc = col(h,'Weekly Collection Goal');
  var avgc = col(h,'Average loan size'), borrowersc = col(h,'active borrowers','Total active borrowers');
  var loansCountc = col(h,'Loans disbursed this week');

  // All-time Fund data
  var fat = FDATA.FundAllTime;
  var fundLoanCol = fat && fat.headers ? col(fat.headers, 'Loan Amount', 'Loan') : null;
  var fundStatusCol = fat && fat.headers ? col(fat.headers, 'Status') : null;
  var fundYearCol = fat && fat.headers ? col(fat.headers, 'Year') : null;

  // === KPI: Total Loans Disbursed (all-time) ===
  if (fat && fat.rows && fat.rows.length && fundLoanCol) {
    var atTotalDisbursed = sum(fat.rows, fundLoanCol);
    document.getElementById('kf-loans').textContent = fmtMoney(atTotalDisbursed);
    document.getElementById('kf-loans-alt').textContent = fmtMoneyAlt(atTotalDisbursed);
    var atAvgLoan = atTotalDisbursed / fat.rows.length;
    document.getElementById('kf-avg').textContent = fmtMoney(atAvgLoan);
    document.getElementById('kf-avg-alt').textContent = fmtMoneyAlt(atAvgLoan);
    document.getElementById('kf-borrowers').textContent = fmtN(fat.rows.length);
    var activeCount = fundStatusCol ? fat.rows.filter(function(r){ return r[fundStatusCol] && String(r[fundStatusCol]).toLowerCase()==='active'; }).length : fat.rows.length;
    document.getElementById('kf-borrowers-alt').textContent = activeCount + ' active borrowers';
  } else {
    var totalDisbursed = dc ? sum(mf.rows, dc) : 0;
    document.getElementById('kf-loans').textContent = fmtMoney(totalDisbursed);
    document.getElementById('kf-loans-alt').textContent = fmtMoneyAlt(totalDisbursed);
    if (avgc) {
      var avgVals = mf.rows.map(function(r){ return N(r[avgc]); }).filter(function(v){ return v > 0; });
      var avgLoan2 = avgVals.length ? avgVals.reduce(function(s,v){return s+v;},0)/avgVals.length : 0;
      document.getElementById('kf-avg').textContent = fmtMoney(avgLoan2);
      document.getElementById('kf-avg-alt').textContent = fmtMoneyAlt(avgLoan2);
    }
    if (borrowersc) {
      var bVals = mf.rows.map(function(r){ return N(r[borrowersc]); }).filter(function(v){ return v > 0; });
      var maxBorrowers = bVals.length ? Math.max.apply(null, bVals) : 0;
      document.getElementById('kf-borrowers').textContent = fmtN(maxBorrowers);
      document.getElementById('kf-borrowers-alt').textContent = 'peak active borrowers';
    }
  }

  // === KPI: This Year's Loans Disbursed (from weekly Microfinance sheet, filtered by current year) ===
  var currentYear = new Date().getFullYear();
  if (dc && yrc) {
    var thisYearRows = mf.rows.filter(function(r){ return N(r[yrc]) === currentYear; });
    var thisYearTotal = sum(thisYearRows, dc);
    document.getElementById('kf-thisyear').textContent = fmtMoney(thisYearTotal);
    document.getElementById('kf-thisyear-alt').textContent = fmtMoneyAlt(thisYearTotal);
  } else if (dc) {
    // Fallback: sum all if no year column
    var allTotal = sum(mf.rows, dc);
    document.getElementById('kf-thisyear').textContent = fmtMoney(allTotal);
    document.getElementById('kf-thisyear-alt').textContent = 'all recorded weeks';
  }

  // === KPI: Repayment Rate ===
  if (ratec) {
    var rvals = mf.rows.map(function(r){ return N(r[ratec]); }).filter(function(v){ return v > 0; });
    var avgR = rvals.length ? rvals.reduce(function(s,v){return s+v;},0)/rvals.length : 0;
    document.getElementById('kf-rate').textContent = avgR.toFixed(1) + '%';
    document.getElementById('kf-rate-alt').textContent = 'avg weekly rate';
  }

  // === KPI: Fund Revenue (from Revenue Tracker) ===
  var rv = FDATA.Revenue;
  if (rv && rv.rows.length) {
    var fundRevRows = rv.rows.filter(function(r){
      var e = (r.Enterprise || '').toLowerCase();
      return e.indexOf('fund') >= 0 || e.indexOf('finance') >= 0;
    });
    var fundRevTotal = sum(fundRevRows, 'Revenue');
    document.getElementById('kf-revenue').textContent = fmtMoney(fundRevTotal);
    document.getElementById('kf-revenue-alt').textContent = fmtMoneyAlt(fundRevTotal);
  }

  if (!wc) return;
  var bw = byWeek(mf.rows, wc), wl = bw.weeks.map(function(w){return 'W'+w;});

  // Chart: Amount Disbursed by Week
  if (dc) mkBar('c-mf-disb', wl, [{ label:'Amount Disbursed', data:bw.weeks.map(function(w){ return sum(bw.groups[w], dc); }), color:'#89D6E5' }]);

  // Chart: Repayment Rate
  if (ratec) mkLine('c-mf-rate', wl, [{ label:'Repayment Rate %', data:bw.weeks.map(function(w){
    var vals = bw.groups[w].map(function(r){ return N(r[ratec]); }).filter(function(v){ return v > 0; });
    return vals.length ? vals.reduce(function(s,v){return s+v;},0)/vals.length : 0;
  }), color:'#4ADE80' }]);

  // Chart: Loans at Risk
  if (riskc) mkBar('c-mf-risk', wl, [{ label:'Loans at Risk', data:bw.weeks.map(function(w){ return sum(bw.groups[w], riskc); }), color:'#F87171' }]);

  // Chart: Goal vs Collected (bar for goal, line for collected)
  if (goalc && collc) {
    var goalData = bw.weeks.map(function(w){ return sum(bw.groups[w], goalc); });
    var collData = bw.weeks.map(function(w){ return sum(bw.groups[w], collc); });
    // Mixed chart: bars for goal, line for actual collected
    mk('c-mf-goalvscoll', 'bar', wl, [
      { label:'Collection Goal', data:goalData, backgroundColor:'#FBBF24B3', hoverBackgroundColor:'#FBBF24E6', borderRadius:6, borderSkipped:false, maxBarThickness:48, order:2 },
      { label:'Actual Collected', data:collData, type:'line', borderColor:'#4ADE80', backgroundColor:'#4ADE8020', borderWidth:2, fill:true, tension:0.35, pointRadius:4, pointHoverRadius:6, pointBackgroundColor:'#292a30', pointBorderColor:'#4ADE80', pointBorderWidth:2, order:1 }
    ]);
  } else if (goalc) {
    mkBar('c-mf-goalvscoll', wl, [{ label:'Collection Goal', data:bw.weeks.map(function(w){ return sum(bw.groups[w], goalc); }), color:'#FBBF24' }]);
  }

  // Chart: Disbursed vs Collected
  if (dc && collc) mkBar('c-mf-coll', wl, [
    { label:'Disbursed', data:bw.weeks.map(function(w){ return sum(bw.groups[w], dc); }), color:'#89D6E5' },
    { label:'Collected', data:bw.weeks.map(function(w){ return sum(bw.groups[w], collc); }), color:'#4ADE80' }
  ]);

  // Chart: Fund Revenue by Week (from Revenue Tracker)
  if (rv && rv.rows.length) {
    var fundRevRows2 = rv.rows.filter(function(r){
      var e = (r.Enterprise || '').toLowerCase();
      return e.indexOf('fund') >= 0 || e.indexOf('finance') >= 0;
    });
    if (fundRevRows2.length) {
      var fBw = byWeek(fundRevRows2, 'Week');
      mkBar('c-mf-fundrev', fBw.weeks.map(function(w){return 'W'+w;}), [{ label:'Fund Revenue', data:fBw.weeks.map(function(w){ return sum(fBw.groups[w], 'Revenue'); }), color:'#4ADE80' }]);
    }
  }

  var dispTotal = (fat && fat.rows && fat.rows.length && fundLoanCol) ? fmtMoney(sum(fat.rows, fundLoanCol)) : fmtMoney(dc ? sum(mf.rows, dc) : 0);
  var dispBorrowers = (fat && fat.rows) ? fmtN(fat.rows.length) : '';
  document.getElementById('ins-fund').innerHTML = '<strong>Fund</strong> — ' + dispTotal + ' total disbursed across ' + dispBorrowers + ' borrowers. ' + currentYear + ' disbursements: ' + document.getElementById('kf-thisyear').textContent + '. Avg repayment rate: ' + document.getElementById('kf-rate').textContent + '.';
}

/* ==== HUB ==== */
function renderHub() {
  var hb = FDATA.Hub;
  if (!hb || !hb.rows.length) return;
  var h = hb.headers, wc = col(h,'Week');
  var revc = col(h,'Weekly Revenue'), evtc = col(h,'Events Hosted'), partc = col(h,'partnerships');
  var prosc = col(h,'Prospects'), footc = col(h,'foot traffic'), clic = col(h,'active clients'), bookc = col(h,'bookings');

  // KPIs
  var totalRev = revc ? sum(hb.rows, revc) : 0;
  document.getElementById('kh-rev').textContent = fmtMoney(totalRev);
  document.getElementById('kh-rev-alt').textContent = fmtMoneyAlt(totalRev);

  var totalEvents = evtc ? sum(hb.rows, evtc) : 0;
  document.getElementById('kh-events').textContent = fmtN(totalEvents);
  document.getElementById('kh-events-alt').textContent = 'events hosted';

  if (clic) {
    var cVals = hb.rows.map(function(r){ return N(r[clic]); }).filter(function(v){ return v > 0; });
    var maxCli = cVals.length ? Math.max.apply(null, cVals) : 0;
    document.getElementById('kh-clients').textContent = fmtN(maxCli);
    document.getElementById('kh-clients-alt').textContent = 'peak active';
  }

  var totalPart = partc ? sum(hb.rows, partc) : 0;
  document.getElementById('kh-partners').textContent = fmtN(totalPart);
  document.getElementById('kh-partners-alt').textContent = 'new partnerships';

  if (!wc) return;
  var bw = byWeek(hb.rows, wc), wl = bw.weeks.map(function(w){return 'W'+w;});
  if (revc) mkBar('c-hb-rev', wl, [{ label:'Revenue', data:bw.weeks.map(function(w){ return sum(bw.groups[w], revc); }), color:'#4ADE80' }]);
  var evtS = [];
  if (evtc) evtS.push({ label:'Events', data:bw.weeks.map(function(w){ return sum(bw.groups[w], evtc); }), color:'#89D6E5' });
  if (partc) evtS.push({ label:'Partnerships', data:bw.weeks.map(function(w){ return sum(bw.groups[w], partc); }), color:'#A78BFA' });
  if (evtS.length) mkBar('c-hb-evt', wl, evtS);
  var prS = [];
  if (prosc) prS.push({ label:'Prospects', data:bw.weeks.map(function(w){ return sum(bw.groups[w], prosc); }), color:'#FBBF24' });
  if (footc) prS.push({ label:'Foot Traffic', data:bw.weeks.map(function(w){ return sum(bw.groups[w], footc); }), color:'#FC5E27' });
  if (prS.length) mkLine('c-hb-pros', wl, prS);
  var cS = [];
  if (clic) cS.push({ label:'Active Clients', data:bw.weeks.map(function(w){ return sum(bw.groups[w], clic); }), color:'#2690B1' });
  if (bookc) cS.push({ label:'Bookings', data:bw.weeks.map(function(w){ return sum(bw.groups[w], bookc); }), color:'#F87171' });
  if (cS.length) mkLine('c-hb-cli', wl, cS);

  document.getElementById('ins-hub').innerHTML = '<strong>Hub</strong> — ' + fmtMoney(totalRev) + ' revenue, ' + fmtN(totalEvents) + ' events hosted.';
}

/* ==== REVENUE ==== */
function renderRevenue() {
  var rv = FDATA.Revenue;
  if (!rv || !rv.rows.length) return;
  var bb = {};
  rv.rows.forEach(function(r) { bb[r.Enterprise] = (bb[r.Enterprise]||0) + N(r.Revenue); });
  var brands = Object.keys(bb).sort(function(a,b){ return bb[b]-bb[a]; });
  var total = Object.values(bb).reduce(function(s,v){return s+v;},0);

  document.getElementById('kr-total').textContent = fmtMoney(total);
  document.getElementById('kr-total-alt').textContent = fmtMoneyAlt(total);

  mkBar('c-rv-bar', brands, [{ label:'Revenue', data:brands.map(function(b){return bb[b];}) }]);
  mkDonut('c-rv-donut', brands, brands.map(function(b){return bb[b];}));
  var bw = byWeek(rv.rows, 'Week');
  mkLine('c-rv-trend', bw.weeks.map(function(w){return 'W'+w;}), brands.slice(0,6).map(function(b){
    return { label:b, data:bw.weeks.map(function(w){ return sum(bw.groups[w].filter(function(r){return r.Enterprise===b;}), 'Revenue'); }), color:BRAND_COLORS[b] };
  }));

  document.getElementById('ins-revenue').innerHTML = '<strong>Revenue</strong> — ' + fmtMoney(total) + ' total. Top brand: ' + brands[0] + ' (' + fmtMoney(bb[brands[0]]) + ').';
}

/* ==== INIT ==== */
google.charts.load('current');
google.charts.setOnLoadCallback(function() {
  var loadEl = document.getElementById('loading');
  var itemsEl = document.getElementById('load-items');
  var sheets = [
    { name:'Elevate', fn: function(){ return queryGSheet(KPI_ID, 'Elevate'); } },
    { name:'Employment', fn: function(){ return queryGSheet(KPI_ID, 'Employment'); } },
    { name:'Microfinance', fn: function(){ return queryGSheet(KPI_ID, 'Microfinance'); } },
    { name:'Hub', fn: function(){ return queryGSheet(KPI_ID, 'Hub'); } },
    { name:'era92 Group', fn: function(){ return queryGSheet(KPI_ID, 'era92 Group'); } },
    { name:'Revenue', fn: queryRevenue }
  ];

  // Try loading the all-time data sheets (may fail if not published)
  sheets.push({ name:'AllTime', fn: function(){ return queryGSheet(ALLTIME_ID, 'Sheet1'); } });
  sheets.push({ name:'FundAllTime', fn: function(){ return queryGSheet(FUND_AT_ID, 'Sheet1'); } });
  sheets.push({ name:'Retainers', fn: function(){ return queryGSheet(RETAINER_ID, 'Sheet1'); } });

  var statuses = {};
  sheets.forEach(function(s) { statuses[s.name] = 'wait'; });
  function updateUI() {
    itemsEl.innerHTML = Object.keys(statuses).map(function(name) {
      var st = statuses[name];
      return '<span class="' + st + '">' + (st==='ok'?'\u2713':st==='err'?'\u2717':'\u23F3') + ' ' + name + '</span>';
    }).join('');
  }
  updateUI();
  Promise.all(sheets.map(function(s) {
    return s.fn().then(function(data) { DATA[s.name] = data; statuses[s.name] = 'ok'; updateUI(); })
      .catch(function(err) { console.warn('Failed:', s.name, err.message); ERRORS.push(s.name+': '+err.message); statuses[s.name] = 'err'; updateUI(); });
  })).then(function() {
    Object.keys(DATA).forEach(function(k) { FDATA[k] = DATA[k]; });
    loadEl.classList.add('hidden');
    if (ERRORS.length > 0) {
      var b = document.getElementById('error-banner');
      b.innerHTML = '<strong>Some sheets need attention:</strong> ' + ERRORS.join('; ') + '<br><small>Ensure sheets are published to web (File → Share → Publish to web).</small>';
      b.classList.add('show');
    }
    document.getElementById('last-updated').textContent = 'Updated ' + new Date().toLocaleString();
    populateFilters(); renderAll();
  });
});
</script>
</body>
</html>
