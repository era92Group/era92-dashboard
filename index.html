<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>era92 Group — Live KPI Dashboard</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --orange: #FC5E27;
  --light-blue: #89D6E5;
  --dark-blue: #2690B1;
  --light-orange: #F2E3DB;
  --bg-dark: #0F1117;
  --bg-card: #1A1D27;
  --bg-sidebar: #141620;
  --bg-input: #242736;
  --border: #2A2D3A;
  --text: #E8EAF0;
  --text-muted: #8B8FA3;
  --text-dim: #5A5E72;
  --positive: #4ADE80;
  --negative: #F87171;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Inter', system-ui, -apple-system, sans-serif; background:var(--bg-dark); color:var(--text); display:flex; min-height:100vh; }

/* ===== SIDEBAR ===== */
.sidebar {
  width: 240px; min-height: 100vh; background: var(--bg-sidebar);
  border-right: 1px solid var(--border); display: flex; flex-direction: column;
  position: fixed; left: 0; top: 0; bottom: 0; z-index: 50;
}
.sidebar-logo {
  padding: 24px 20px 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
}
.sidebar-logo .logo-icon {
  width: 36px; height: 36px; border-radius: 10px;
  background: linear-gradient(135deg, var(--orange) 0%, #FF8A5C 100%);
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 14px; color: white;
}
.sidebar-logo .logo-text { font-size: 16px; font-weight: 700; color: var(--text); }
.sidebar-logo .logo-sub { font-size: 11px; color: var(--text-muted); margin-top: 1px; }

.sidebar-nav { padding: 16px 12px; flex: 1; overflow-y: auto; }
.nav-label { font-size: 10px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.2px; padding: 8px 12px 6px; }
.nav-item {
  display: flex; align-items: center; gap: 10px; padding: 10px 12px; margin: 2px 0;
  border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500;
  color: var(--text-muted); transition: all 0.15s;
}
.nav-item:hover { background: var(--bg-input); color: var(--text); }
.nav-item.active { background: var(--orange); color: white; }
.nav-item .nav-icon { width: 18px; height: 18px; opacity: 0.7; }
.nav-item.active .nav-icon { opacity: 1; }

.sidebar-footer {
  padding: 16px 20px; border-top: 1px solid var(--border);
  font-size: 11px; color: var(--text-dim);
}

/* ===== MAIN CONTENT ===== */
.main { margin-left: 240px; flex: 1; min-height: 100vh; }

/* Top bar */
.topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 32px; border-bottom: 1px solid var(--border);
  background: var(--bg-sidebar);
}
.topbar-left { display: flex; align-items: center; gap: 16px; }
.topbar-title { font-size: 18px; font-weight: 700; }
.topbar-date { font-size: 12px; color: var(--text-muted); background: var(--bg-input); padding: 4px 12px; border-radius: 12px; }
.topbar-right { display: flex; align-items: center; gap: 12px; }
.refresh-btn {
  background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted);
  padding: 7px 14px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 500;
  font-family: inherit; transition: all 0.15s;
}
.refresh-btn:hover { border-color: var(--orange); color: var(--text); }
.last-updated { font-size: 11px; color: var(--text-dim); }

/* Filters */
.filter-bar {
  display: flex; gap: 10px; padding: 12px 32px; border-bottom: 1px solid var(--border);
  background: var(--bg-dark); flex-wrap: wrap; align-items: center;
}
.filter-group { display: flex; align-items: center; gap: 6px; }
.filter-group label { font-size: 11px; color: var(--text-dim); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.filter-group select {
  padding: 5px 10px; border: 1px solid var(--border); border-radius: 6px;
  font-size: 12px; color: var(--text); background: var(--bg-input);
  cursor: pointer; font-family: inherit;
}
.filter-group select:focus { border-color: var(--orange); outline: none; }
.filter-group select option { background: var(--bg-card); color: var(--text); }

/* KPI Strip */
.kpi-strip {
  display: grid; grid-template-columns: repeat(6, 1fr);
  gap: 16px; padding: 24px 32px;
}
.kpi-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 12px; padding: 20px;
}
.kpi-card .kpi-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 500; }
.kpi-card .kpi-value { font-size: 26px; font-weight: 700; color: var(--text); }
.kpi-card .kpi-change { font-size: 11px; font-weight: 600; margin-top: 6px; }
.kpi-card .kpi-change.up { color: var(--positive); }
.kpi-card .kpi-change.down { color: var(--negative); }
.kpi-card .kpi-icon {
  width: 32px; height: 32px; border-radius: 8px; display: flex;
  align-items: center; justify-content: center; margin-bottom: 12px; font-size: 16px;
}

/* Section content */
.page-content { padding: 24px 32px; }
.section { display: none; }
.section.active { display: block; }
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.full { grid-column: 1 / -1; }

.card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 12px; padding: 24px;
}
.card h3 {
  font-size: 13px; font-weight: 600; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 16px;
}
.card canvas { width: 100% !important; max-height: 280px; }

.insight-box {
  background: rgba(252,94,39,0.08); border-left: 3px solid var(--orange);
  padding: 14px 18px; border-radius: 0 10px 10px 0; margin-bottom: 20px;
  font-size: 13px; line-height: 1.6; color: var(--text-muted);
}
.insight-box strong { color: var(--orange); }

/* Loading */
.loading-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: var(--bg-dark); display: flex; flex-direction: column;
  align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.4s;
}
.loading-overlay.hidden { opacity: 0; pointer-events: none; }
.spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--orange);
  border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
@keyframes spin { to { transform: rotate(360deg); } }
.load-status { font-size: 14px; color: var(--text-muted); }
.load-items { margin-top: 14px; font-size: 12px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
.load-items span { padding: 3px 10px; border-radius: 12px; }
.load-items .ok { background: rgba(74,222,128,0.12); color: var(--positive); }
.load-items .err { background: rgba(248,113,113,0.12); color: var(--negative); }
.load-items .wait { background: var(--bg-input); color: var(--text-dim); }

.error-banner {
  background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.2); color: var(--negative);
  padding: 12px 20px; margin: 0 32px 16px; border-radius: 10px; font-size: 12px; display: none;
}
.error-banner.show { display: block; }

/* SVG Icons inline */
.ico { display: inline-block; width: 18px; height: 18px; vertical-align: middle; }

@media (max-width: 1100px) {
  .kpi-strip { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 900px) {
  .sidebar { display: none; }
  .main { margin-left: 0; }
  .grid2, .grid3 { grid-template-columns: 1fr; }
  .kpi-strip { grid-template-columns: repeat(2, 1fr); }
  .topbar, .filter-bar, .page-content { padding-left: 16px; padding-right: 16px; }
}
</style>
</head>
<body>

<!-- Loading overlay -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="load-status">Pulling live data from Google Sheets...</div>
  <div class="load-items" id="load-items"></div>
</div>

<!-- SIDEBAR -->
<nav class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">e92</div>
    <div>
      <div class="logo-text">era92 Group</div>
      <div class="logo-sub">KPI Dashboard</div>
    </div>
  </div>
  <div class="sidebar-nav">
    <div class="nav-label">Dashboard</div>
    <div class="nav-item active" data-tab="overview">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Overview
    </div>
    <div class="nav-item" data-tab="revenue">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      Revenue
    </div>
    <div class="nav-label" style="margin-top:12px">Programs</div>
    <div class="nav-item" data-tab="elevate">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
      Elevate
    </div>
    <div class="nav-item" data-tab="employment">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>
      Employment
    </div>
    <div class="nav-item" data-tab="microfinance">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></svg>
      Microfinance
    </div>
    <div class="nav-item" data-tab="hub">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Hub
    </div>
    <div class="nav-item" data-tab="group">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      Group HR
    </div>
  </div>
  <div class="sidebar-footer">
    <span id="last-updated"></span>
  </div>
</nav>

<!-- MAIN -->
<div class="main">

  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-title">Dashboard</div>
      <div class="topbar-date" id="date-range">Loading...</div>
    </div>
    <div class="topbar-right">
      <button class="refresh-btn" onclick="location.reload()">Refresh</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-bar">
    <div class="filter-group"><label>Week</label><select id="f-week" onchange="applyFilters()"><option value="">All</option></select></div>
    <div class="filter-group"><label>Quarter</label><select id="f-quarter" onchange="applyFilters()"><option value="">All</option></select></div>
    <div class="filter-group"><label>Year</label><select id="f-year" onchange="applyFilters()"><option value="">All</option></select></div>
    <div class="filter-group"><label>Location</label><select id="f-location" onchange="applyFilters()"><option value="">All</option></select></div>
    <div class="filter-group"><label>Brand</label><select id="f-brand" onchange="applyFilters()"><option value="">All</option></select></div>
  </div>

  <!-- Error banner -->
  <div class="error-banner" id="error-banner"></div>

  <!-- KPI Strip -->
  <div class="kpi-strip">
    <div class="kpi-card">
      <div class="kpi-icon" style="background:rgba(252,94,39,0.12);color:var(--orange)">$</div>
      <div class="kpi-label">Total Revenue</div>
      <div class="kpi-value" id="k-rev">—</div>
      <div class="kpi-change" id="k-rev-c"></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon" style="background:rgba(137,214,229,0.12);color:var(--light-blue)">E</div>
      <div class="kpi-label">Total Enrollments</div>
      <div class="kpi-value" id="k-enr">—</div>
      <div class="kpi-change" id="k-enr-c"></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon" style="background:rgba(38,144,177,0.12);color:var(--dark-blue)">L</div>
      <div class="kpi-label">Loans Disbursed</div>
      <div class="kpi-value" id="k-loan">—</div>
      <div class="kpi-change" id="k-loan-c"></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon" style="background:rgba(74,222,128,0.12);color:var(--positive)">J</div>
      <div class="kpi-label">Job Placements</div>
      <div class="kpi-value" id="k-plc">—</div>
      <div class="kpi-change" id="k-plc-c"></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon" style="background:rgba(242,227,219,0.12);color:var(--light-orange)">H</div>
      <div class="kpi-label">Total Hires</div>
      <div class="kpi-value" id="k-hire">—</div>
      <div class="kpi-change" id="k-hire-c"></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon" style="background:rgba(74,222,128,0.12);color:var(--positive)">%</div>
      <div class="kpi-label">Repayment Rate</div>
      <div class="kpi-value" id="k-rate">—</div>
      <div class="kpi-change" id="k-rate-c"></div>
    </div>
  </div>

  <!-- Page Content -->
  <div class="page-content">

    <!-- OVERVIEW -->
    <div class="section active" id="sec-overview">
      <div class="insight-box" id="ins-overview"><strong>Loading...</strong></div>
      <div class="grid2">
        <div class="card"><h3>Revenue by Brand</h3><canvas id="c-ov-brand"></canvas></div>
        <div class="card"><h3>Weekly Revenue Trend</h3><canvas id="c-ov-revtrend"></canvas></div>
      </div>
      <div class="grid3">
        <div class="card"><h3>Enrollment by Location</h3><canvas id="c-ov-enroll"></canvas></div>
        <div class="card"><h3>Placements by Week</h3><canvas id="c-ov-place"></canvas></div>
        <div class="card"><h3>Microfinance Loans</h3><canvas id="c-ov-loans"></canvas></div>
      </div>
    </div>

    <!-- REVENUE -->
    <div class="section" id="sec-revenue">
      <div class="insight-box" id="ins-revenue"><strong>Loading...</strong></div>
      <div class="grid2">
        <div class="card"><h3>Revenue by Brand</h3><canvas id="c-rv-bar"></canvas></div>
        <div class="card"><h3>Revenue Share</h3><canvas id="c-rv-donut"></canvas></div>
      </div>
      <div class="grid2">
        <div class="card full"><h3>Weekly Revenue Trend by Brand</h3><canvas id="c-rv-trend"></canvas></div>
      </div>
    </div>

    <!-- ELEVATE -->
    <div class="section" id="sec-elevate">
      <div class="insight-box" id="ins-elevate"><strong>Loading...</strong></div>
      <div class="grid2">
        <div class="card"><h3>Weekly Enrollment by Hub</h3><canvas id="c-el-enroll"></canvas></div>
        <div class="card"><h3>Weekly Admissions by Hub</h3><canvas id="c-el-admit"></canvas></div>
      </div>
      <div class="grid2">
        <div class="card"><h3>Gender Split (Admissions)</h3><canvas id="c-el-gender"></canvas></div>
        <div class="card"><h3>Refugee Enrollment</h3><canvas id="c-el-refugee"></canvas></div>
      </div>
    </div>

    <!-- EMPLOYMENT -->
    <div class="section" id="sec-employment">
      <div class="insight-box" id="ins-employment"><strong>Loading...</strong></div>
      <div class="grid2">
        <div class="card"><h3>New Placements by Week</h3><canvas id="c-em-place"></canvas></div>
        <div class="card"><h3>Income Earned (UGX)</h3><canvas id="c-em-income"></canvas></div>
      </div>
      <div class="grid2">
        <div class="card"><h3>Active Projects</h3><canvas id="c-em-proj"></canvas></div>
        <div class="card"><h3>Interviews Completed</h3><canvas id="c-em-intv"></canvas></div>
      </div>
    </div>

    <!-- MICROFINANCE -->
    <div class="section" id="sec-microfinance">
      <div class="insight-box" id="ins-micro"><strong>Loading...</strong></div>
      <div class="grid2">
        <div class="card"><h3>Loans Disbursed by Week</h3><canvas id="c-mf-disb"></canvas></div>
        <div class="card"><h3>Repayment Rate (%)</h3><canvas id="c-mf-rate"></canvas></div>
      </div>
      <div class="grid2">
        <div class="card"><h3>Loans at Risk (30+ days)</h3><canvas id="c-mf-risk"></canvas></div>
        <div class="card"><h3>Disbursed vs Collected</h3><canvas id="c-mf-coll"></canvas></div>
      </div>
    </div>

    <!-- HUB -->
    <div class="section" id="sec-hub">
      <div class="insight-box" id="ins-hub"><strong>Loading...</strong></div>
      <div class="grid2">
        <div class="card"><h3>Hub Revenue by Week</h3><canvas id="c-hb-rev"></canvas></div>
        <div class="card"><h3>Events & Partnerships</h3><canvas id="c-hb-evt"></canvas></div>
      </div>
      <div class="grid2">
        <div class="card"><h3>Prospects & Foot Traffic</h3><canvas id="c-hb-pros"></canvas></div>
        <div class="card"><h3>Active Clients & Bookings</h3><canvas id="c-hb-cli"></canvas></div>
      </div>
    </div>

    <!-- GROUP HR -->
    <div class="section" id="sec-group">
      <div class="insight-box" id="ins-group"><strong>Loading...</strong></div>
      <div class="grid2">
        <div class="card"><h3>Applications & Interviews</h3><canvas id="c-gr-app"></canvas></div>
        <div class="card"><h3>Hires & Trainings</h3><canvas id="c-gr-hire"></canvas></div>
      </div>
    </div>

  </div>
</div>

<script>
/* ==================================================
   era92 Group Live Dashboard — Dark Theme
   Google Visualization API for data fetch
   ================================================== */

/* Chart.js dark theme defaults */
Chart.defaults.color = '#8B8FA3';
Chart.defaults.borderColor = '#2A2D3A';
Chart.defaults.plugins.legend.labels.color = '#8B8FA3';

var COLORS = ['#FC5E27','#89D6E5','#2690B1','#F2E3DB','#4ADE80','#A78BFA','#F87171','#FBBF24'];
var BRAND_COLORS = {'92 Cafe':'#FC5E27','92 CarWash':'#89D6E5','era92 Hub':'#2690B1','era92 Creative':'#A78BFA','era92 Elevate':'#F2E3DB','era92 Finance':'#4ADE80'};
var LOC_COLORS = {'Lungujja':'#FC5E27','Katanga':'#89D6E5','Jinja':'#4ADE80','Namayemba':'#A78BFA'};

var KPI_ID = '1fch4Cy5sj1VQ_iaD2NK0SoOE1EKjsr_7YmZSUt3-ngU';
var REV_ID = '1n4eFTqFmyvm9xEY-meoio2v6qFoCow7mwC6BU0wNAhI';

var DATA = {}, FDATA = {}, CHARTS = {}, ERRORS = [];

/* ---- Sidebar nav ---- */
document.querySelector('.sidebar-nav').addEventListener('click', function(e) {
  var item = e.target.closest('.nav-item');
  if (!item) return;
  document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
  document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
  item.classList.add('active');
  var sec = document.getElementById('sec-' + item.getAttribute('data-tab'));
  if (sec) sec.classList.add('active');
  // Update topbar title
  document.querySelector('.topbar-title').textContent = item.textContent.trim();
});

/* ---- Query Google Sheet via Visualization API ---- */
function queryGSheet(sheetId, tabName) {
  return new Promise(function(resolve, reject) {
    try {
      var url = 'https://docs.google.com/spreadsheets/d/' + sheetId + '/gviz/tq?sheet=' + encodeURIComponent(tabName);
      var q = new google.visualization.Query(url);
      q.setTimeout(20);
      q.send(function(resp) {
        try {
          if (resp.isError()) { reject(new Error(resp.getMessage())); return; }
          var t = resp.getDataTable();
          var nc = t.getNumberOfColumns(), nr = t.getNumberOfRows();
          var hdrs = [];
          for (var c = 0; c < nc; c++) hdrs.push(t.getColumnLabel(c) || t.getColumnId(c));
          var rows = [];
          for (var r = 0; r < nr; r++) {
            var obj = {}, hasVal = false;
            for (var c2 = 0; c2 < nc; c2++) {
              var v = t.getValue(r, c2);
              obj[hdrs[c2]] = v;
              if (v !== null && v !== undefined && v !== '') hasVal = true;
            }
            if (hasVal) rows.push(obj);
          }
          resolve({ headers: hdrs, rows: rows });
        } catch (e) { reject(e); }
      });
    } catch (e) { reject(e); }
  });
}

function queryRevenue() {
  return new Promise(function(resolve, reject) {
    try {
      var url = 'https://docs.google.com/spreadsheets/d/' + REV_ID + '/gviz/tq?sheet=Sheet1';
      var q = new google.visualization.Query(url);
      q.setTimeout(20);
      q.send(function(resp) {
        try {
          if (resp.isError()) { reject(new Error(resp.getMessage())); return; }
          var t = resp.getDataTable();
          var nr = t.getNumberOfRows(), nc = t.getNumberOfColumns();
          var COLS = { Dates:0, Week:1, Quarter:2, Year:3, Enterprise:4, Revenue:5, NewDonors:7 };
          var rows = [];
          for (var r = 0; r < nr; r++) {
            var enterprise = t.getValue(r, COLS.Enterprise);
            var revenue = t.getValue(r, COLS.Revenue);
            if (!enterprise || typeof enterprise !== 'string') continue;
            if (enterprise.toLowerCase().includes('total') || enterprise.toLowerCase().includes('enterprise')) continue;
            rows.push({
              Dates: t.getValue(r, COLS.Dates),
              Week: t.getValue(r, COLS.Week),
              Quarter: t.getValue(r, COLS.Quarter),
              Year: t.getValue(r, COLS.Year),
              Enterprise: enterprise.trim(),
              Revenue: typeof revenue === 'number' ? revenue : parseFloat(String(revenue).replace(/,/g,'')) || 0,
              NewDonors: t.getValue(r, COLS.NewDonors)
            });
          }
          resolve({ headers: ['Dates','Week','Quarter','Year','Enterprise','Revenue','NewDonors'], rows: rows });
        } catch (e) { reject(e); }
      });
    } catch (e) { reject(e); }
  });
}

/* ---- Utilities ---- */
function N(v) { return typeof v === 'number' ? v : parseFloat(v) || 0; }
function fmtUGX(v) {
  v = N(v);
  if (v >= 1e9) return 'UGX ' + (v/1e9).toFixed(1) + 'B';
  if (v >= 1e6) return 'UGX ' + (v/1e6).toFixed(1) + 'M';
  if (v >= 1e3) return 'UGX ' + (v/1e3).toFixed(0) + 'K';
  return 'UGX ' + Math.round(v).toLocaleString();
}
function fmtN(v) { v = N(v); if (v >= 1e6) return (v/1e6).toFixed(1)+'M'; if (v >= 1e3) return (v/1e3).toFixed(1)+'K'; return Math.round(v).toLocaleString(); }
function sum(rows, col) { return rows.reduce(function(s,r){ return s + N(r[col]); }, 0); }
function col(hdrs) {
  var args = Array.prototype.slice.call(arguments, 1);
  for (var i = 0; i < args.length; i++) {
    var kw = args[i].toLowerCase();
    var m = hdrs.find(function(h){ return h && h.toLowerCase().indexOf(kw) >= 0; });
    if (m) return m;
  }
  return null;
}

function byWeek(rows, weekCol) {
  var g = {};
  rows.forEach(function(r) {
    var w = N(r[weekCol]);
    if (!w) return;
    if (!g[w]) g[w] = [];
    g[w].push(r);
  });
  var weeks = Object.keys(g).map(Number).sort(function(a,b){return a-b;});
  return { weeks: weeks, groups: g };
}

/* ---- Chart factory (dark themed) ---- */
function mk(id, type, labels, datasets, opts) {
  if (CHARTS[id]) CHARTS[id].destroy();
  var el = document.getElementById(id);
  if (!el) return;
  var isDoughnut = type==='doughnut'||type==='pie';
  var base = {
    responsive: true, maintainAspectRatio: false, animation: false,
    plugins: {
      legend: { position:'top', labels: { usePointStyle:true, padding:12, font:{size:11}, color:'#8B8FA3' } },
      tooltip: { backgroundColor:'#1A1D27', titleColor:'#E8EAF0', bodyColor:'#8B8FA3', borderColor:'#2A2D3A', borderWidth:1, cornerRadius:8, padding:10 }
    },
    scales: isDoughnut ? {} : {
      x:{ grid:{display:false, color:'#2A2D3A'}, ticks:{color:'#5A5E72', font:{size:11}} },
      y:{ beginAtZero:true, grid:{color:'#1E2130'}, ticks:{color:'#5A5E72', font:{size:11}} }
    }
  };
  var o = Object.assign({}, base, opts || {});
  CHARTS[id] = new Chart(el, { type:type, data:{labels:labels, datasets:datasets}, options:o });
}

function mkLine(id, labels, series) {
  mk(id, 'line', labels, series.map(function(s,i){
    return { label:s.label, data:s.data, borderColor:s.color||COLORS[i%COLORS.length], backgroundColor:(s.color||COLORS[i%COLORS.length])+'20', borderWidth:2, fill:false, tension:0.4, pointRadius:3, pointBackgroundColor:s.color||COLORS[i%COLORS.length] };
  }));
}
function mkBar(id, labels, series, stacked) {
  var ds = series.map(function(s,i){ return { label:s.label, data:s.data, backgroundColor:(s.color||COLORS[i%COLORS.length])+'CC', borderRadius:6, borderSkipped:false }; });
  var opts = stacked ? { scales:{x:{stacked:true,grid:{display:false},ticks:{color:'#5A5E72'}},y:{stacked:true,beginAtZero:true,grid:{color:'#1E2130'},ticks:{color:'#5A5E72'}}} } : undefined;
  mk(id, 'bar', labels, ds, opts);
}
function mkDonut(id, labels, data) {
  mk(id, 'doughnut', labels, [{ data:data, backgroundColor:labels.map(function(l,i){ return (BRAND_COLORS[l]||COLORS[i%COLORS.length])+'CC'; }), borderWidth:2, borderColor:'#1A1D27' }], { cutout:'60%' });
}

/* ==== FILTERS ==== */
function applyFilters() {
  var fw = document.getElementById('f-week').value;
  var fq = document.getElementById('f-quarter').value;
  var fy = document.getElementById('f-year').value;
  var fl = document.getElementById('f-location').value;
  var fb = document.getElementById('f-brand').value;

  Object.keys(DATA).forEach(function(name) {
    var sheet = DATA[name];
    if (!sheet || !sheet.rows) { FDATA[name] = sheet; return; }
    var h = sheet.headers;
    var wc = col(h,'Week'), qc = col(h,'Quarter'), yc = col(h,'Year');
    var lc = col(h,'Hub Location','Location','Branch');
    var bc = col(h,'Enterprise','Brand');
    FDATA[name] = {
      headers: h,
      rows: sheet.rows.filter(function(r) {
        if (fw && wc && N(r[wc]) !== N(fw)) return false;
        if (fq && qc && String(N(r[qc])) !== fq) return false;
        if (fy && yc && String(N(r[yc])) !== fy) return false;
        if (fl && lc && String(r[lc]) !== fl) return false;
        if (fb && bc && String(r[bc]) !== fb) return false;
        return true;
      })
    };
  });
  renderAll();
}

function populateFilters() {
  var weeks = new Set(), quarters = new Set(), years = new Set(), locations = new Set(), brands = new Set();
  Object.values(DATA).forEach(function(s) {
    if (!s || !s.rows) return;
    s.rows.forEach(function(r) {
      var wc = col(s.headers,'Week'); if (wc && N(r[wc])) weeks.add(N(r[wc]));
      var qc = col(s.headers,'Quarter'); if (qc && r[qc]) quarters.add(String(N(r[qc])));
      var yc = col(s.headers,'Year'); if (yc && r[yc]) years.add(String(N(r[yc])));
      var lc = col(s.headers,'Hub Location','Location','Branch'); if (lc && r[lc]) locations.add(String(r[lc]));
      var bc = col(s.headers,'Enterprise','Brand'); if (bc && r[bc]) brands.add(String(r[bc]));
    });
  });
  function fill(selId, vals, prefix) {
    var sel = document.getElementById(selId);
    Array.from(vals).sort(function(a,b){ return N(a)-N(b)||String(a).localeCompare(String(b)); }).forEach(function(v) {
      if (!v || v==='NaN') return;
      var o = document.createElement('option'); o.value = v; o.textContent = (prefix||'') + v; sel.appendChild(o);
    });
  }
  fill('f-week', weeks, 'Week '); fill('f-quarter', quarters, 'Q'); fill('f-year', years, '');
  fill('f-location', locations, ''); fill('f-brand', brands, '');
  if (weeks.size > 0) {
    var maxW = Math.max.apply(null, Array.from(weeks));
    var minW = Math.min.apply(null, Array.from(weeks));
    var yr = years.size > 0 ? Math.max.apply(null, Array.from(years).map(Number)) : 2026;
    document.getElementById('date-range').textContent = 'Weeks ' + minW + ' – ' + maxW + ', ' + yr;
  }
}

/* ==== RENDER ==== */
function renderAll() {
  try { renderKPIs(); } catch(e) { console.warn('KPI:', e); }
  try { renderOverview(); } catch(e) { console.warn('Overview:', e); }
  try { renderRevenue(); } catch(e) { console.warn('Revenue:', e); }
  try { renderElevate(); } catch(e) { console.warn('Elevate:', e); }
  try { renderEmployment(); } catch(e) { console.warn('Employment:', e); }
  try { renderMicrofinance(); } catch(e) { console.warn('Microfinance:', e); }
  try { renderHub(); } catch(e) { console.warn('Hub:', e); }
  try { renderGroup(); } catch(e) { console.warn('Group:', e); }
}

/* ==== KPIs ==== */
function renderKPIs() {
  var rv = FDATA.Revenue;
  if (rv && rv.rows.length) document.getElementById('k-rev').textContent = fmtUGX(sum(rv.rows, 'Revenue'));

  var el = FDATA.Elevate;
  if (el && el.rows.length) {
    var ec = col(el.headers, 'enrolled');
    if (ec) document.getElementById('k-enr').textContent = fmtN(sum(el.rows, ec));
  }

  var mf = FDATA.Microfinance;
  if (mf && mf.rows.length) {
    var lc = col(mf.headers, 'Loans disbursed this week');
    if (lc) document.getElementById('k-loan').textContent = fmtN(sum(mf.rows, lc));
    // Repayment rate
    var ratec = col(mf.headers, 'Repayment rate');
    if (ratec) {
      var vals = mf.rows.map(function(r){ return N(r[ratec]); }).filter(function(v){ return v > 0; });
      var avg = vals.length ? vals.reduce(function(s,v){return s+v;},0)/vals.length : 0;
      document.getElementById('k-rate').textContent = avg.toFixed(1) + '%';
    }
  }

  var em = FDATA.Employment;
  if (em && em.rows.length) {
    var pc = col(em.headers, 'New placements');
    if (pc) document.getElementById('k-plc').textContent = fmtN(sum(em.rows, pc));
  }

  var gr = FDATA['era92 Group'];
  if (gr && gr.rows.length) {
    var hc = col(gr.headers, 'Hires');
    if (hc) document.getElementById('k-hire').textContent = fmtN(sum(gr.rows, hc));
  }
}

/* ==== OVERVIEW ==== */
function renderOverview() {
  var rv = FDATA.Revenue;
  if (rv && rv.rows.length) {
    var bb = {};
    rv.rows.forEach(function(r) { bb[r.Enterprise] = (bb[r.Enterprise]||0) + N(r.Revenue); });
    var brands = Object.keys(bb).sort(function(a,b){ return bb[b]-bb[a]; });
    mkBar('c-ov-brand', brands, [{ label:'Revenue (UGX)', data:brands.map(function(b){return bb[b];}) }]);
    var wk = col(rv.headers, 'Week');
    if (wk) {
      var bw = byWeek(rv.rows, wk);
      mkLine('c-ov-revtrend', bw.weeks.map(function(w){return 'W'+w;}), [{ label:'Total Revenue', data:bw.weeks.map(function(w){ return sum(bw.groups[w],'Revenue'); }), color:'#FC5E27' }]);
    }
  }
  var el = FDATA.Elevate;
  if (el && el.rows.length) {
    var wc = col(el.headers, 'Week'), ec = col(el.headers, 'enrolled'), lc2 = col(el.headers, 'Hub Location');
    if (wc && ec) {
      var bw2 = byWeek(el.rows, wc);
      var wl2 = bw2.weeks.map(function(w){return 'W'+w;});
      if (lc2) {
        mkBar('c-ov-enroll', wl2, ['Lungujja','Katanga','Jinja','Namayemba'].map(function(loc){
          return { label:loc, data:bw2.weeks.map(function(w){ return sum(bw2.groups[w].filter(function(r){return r[lc2]===loc;}), ec); }), color:LOC_COLORS[loc] };
        }), true);
      } else {
        mkBar('c-ov-enroll', wl2, [{ label:'Enrollments', data:bw2.weeks.map(function(w){ return sum(bw2.groups[w], ec); }) }]);
      }
    }
  }
  var em = FDATA.Employment;
  if (em && em.rows.length) {
    var wc3 = col(em.headers, 'Week'), pc = col(em.headers, 'New placements');
    if (wc3 && pc) {
      var bw3 = byWeek(em.rows, wc3);
      mkBar('c-ov-place', bw3.weeks.map(function(w){return 'W'+w;}), [{ label:'Placements', data:bw3.weeks.map(function(w){ return sum(bw3.groups[w], pc); }), color:'#4ADE80' }]);
    }
  }
  var mf = FDATA.Microfinance;
  if (mf && mf.rows.length) {
    var wc4 = col(mf.headers, 'Week'), dc = col(mf.headers, 'Loans disbursed this week');
    if (wc4 && dc) {
      var bw4 = byWeek(mf.rows, wc4);
      mkBar('c-ov-loans', bw4.weeks.map(function(w){return 'W'+w;}), [{ label:'Loans', data:bw4.weeks.map(function(w){ return sum(bw4.groups[w], dc); }), color:'#89D6E5' }]);
    }
  }
  var loaded = Object.keys(FDATA).filter(function(k){ return FDATA[k] && FDATA[k].rows && FDATA[k].rows.length > 0; });
  document.getElementById('ins-overview').innerHTML = '<strong>Dashboard Overview:</strong> Live data from ' + loaded.length + ' sources. Use filters to drill down by week, quarter, brand, or location.';
}

/* ==== REVENUE ==== */
function renderRevenue() {
  var rv = FDATA.Revenue;
  if (!rv || !rv.rows.length) return;
  var bb = {};
  rv.rows.forEach(function(r) { bb[r.Enterprise] = (bb[r.Enterprise]||0) + N(r.Revenue); });
  var brands = Object.keys(bb).sort(function(a,b){ return bb[b]-bb[a]; });
  mkBar('c-rv-bar', brands, [{ label:'Revenue (UGX)', data:brands.map(function(b){return bb[b];}) }]);
  mkDonut('c-rv-donut', brands, brands.map(function(b){return bb[b];}));
  var bw = byWeek(rv.rows, 'Week');
  mkLine('c-rv-trend', bw.weeks.map(function(w){return 'W'+w;}), brands.slice(0,6).map(function(b){
    return { label:b, data:bw.weeks.map(function(w){ return sum(bw.groups[w].filter(function(r){return r.Enterprise===b;}), 'Revenue'); }), color:BRAND_COLORS[b] };
  }));
  var total = Object.values(bb).reduce(function(s,v){return s+v;},0);
  document.getElementById('ins-revenue').innerHTML = '<strong>Revenue:</strong> ' + fmtUGX(total) + ' total. Top brand: ' + brands[0] + ' (' + fmtUGX(bb[brands[0]]) + ').';
}

/* ==== ELEVATE ==== */
function renderElevate() {
  var el = FDATA.Elevate;
  if (!el || !el.rows.length) return;
  var h = el.headers, wc = col(h,'Week'), lc = col(h,'Hub Location');
  var ec = col(h,'enrolled'), ac = col(h,'admitted'), mc = col(h,'Male'), fc = col(h,'Female'), rc = col(h,'Refugee');
  if (!wc) return;
  var bw = byWeek(el.rows, wc), wl = bw.weeks.map(function(w){return 'W'+w;});
  var locs = ['Lungujja','Katanga','Jinja','Namayemba'];
  if (ec && lc) mkBar('c-el-enroll', wl, locs.map(function(loc){ return { label:loc, data:bw.weeks.map(function(w){ return sum(bw.groups[w].filter(function(r){return r[lc]===loc;}), ec); }), color:LOC_COLORS[loc] }; }), true);
  if (ac && lc) mkBar('c-el-admit', wl, locs.map(function(loc){ return { label:loc, data:bw.weeks.map(function(w){ return sum(bw.groups[w].filter(function(r){return r[lc]===loc;}), ac); }), color:LOC_COLORS[loc] }; }), true);
  if (mc && fc) mkBar('c-el-gender', wl, [
    { label:'Male', data:bw.weeks.map(function(w){ return sum(bw.groups[w], mc); }), color:'#89D6E5' },
    { label:'Female', data:bw.weeks.map(function(w){ return sum(bw.groups[w], fc); }), color:'#FC5E27' }
  ], true);
  if (rc) mkBar('c-el-refugee', wl, [{ label:'Refugees', data:bw.weeks.map(function(w){ return sum(bw.groups[w], rc); }), color:'#A78BFA' }]);
  document.getElementById('ins-elevate').innerHTML = '<strong>Elevate:</strong> ' + fmtN(ec ? sum(el.rows, ec) : 0) + ' enrolled, ' + fmtN(ac ? sum(el.rows, ac) : 0) + ' admitted.';
}

/* ==== EMPLOYMENT ==== */
function renderEmployment() {
  var em = FDATA.Employment;
  if (!em || !em.rows.length) return;
  var h = em.headers, wc = col(h,'Week');
  var pc = col(h,'New placements'), ic = col(h,'income earned'), prc = col(h,'active projects'), intc = col(h,'interviews completed');
  if (!wc) return;
  var bw = byWeek(em.rows, wc), wl = bw.weeks.map(function(w){return 'W'+w;});
  if (pc) mkBar('c-em-place', wl, [{ label:'New Placements', data:bw.weeks.map(function(w){ return sum(bw.groups[w], pc); }), color:'#4ADE80' }]);
  if (ic) mkLine('c-em-income', wl, [{ label:'Income (UGX)', data:bw.weeks.map(function(w){ return sum(bw.groups[w], ic); }), color:'#89D6E5' }]);
  if (prc) mkLine('c-em-proj', wl, [{ label:'Active Projects', data:bw.weeks.map(function(w){ return sum(bw.groups[w], prc); }), color:'#2690B1' }]);
  if (intc) mkBar('c-em-intv', wl, [{ label:'Interviews', data:bw.weeks.map(function(w){ return sum(bw.groups[w], intc); }), color:'#FBBF24' }]);
  document.getElementById('ins-employment').innerHTML = '<strong>Employment:</strong> ' + fmtN(pc ? sum(em.rows, pc) : 0) + ' placements, ' + fmtUGX(ic ? sum(em.rows, ic) : 0) + ' income earned.';
}

/* ==== MICROFINANCE ==== */
function renderMicrofinance() {
  var mf = FDATA.Microfinance;
  if (!mf || !mf.rows.length) return;
  var h = mf.headers, wc = col(h,'Week');
  var dc = col(h,'Loans disbursed this week'), ratec = col(h,'Repayment rate'), riskc = col(h,'loans at risk');
  var collc = col(h,'Actual Weekly repayment'), goalc = col(h,'Weekly Collection Goal');
  if (!wc) return;
  var bw = byWeek(mf.rows, wc), wl = bw.weeks.map(function(w){return 'W'+w;});
  if (dc) mkBar('c-mf-disb', wl, [{ label:'Loans Disbursed', data:bw.weeks.map(function(w){ return sum(bw.groups[w], dc); }), color:'#89D6E5' }]);
  if (ratec) mkLine('c-mf-rate', wl, [{ label:'Repayment Rate %', data:bw.weeks.map(function(w){
    var vals = bw.groups[w].map(function(r){ return N(r[ratec]); }).filter(function(v){ return v > 0; });
    return vals.length ? vals.reduce(function(s,v){return s+v;},0)/vals.length : 0;
  }), color:'#4ADE80' }]);
  if (riskc) mkBar('c-mf-risk', wl, [{ label:'Loans at Risk', data:bw.weeks.map(function(w){ return sum(bw.groups[w], riskc); }), color:'#F87171' }]);
  if (dc && collc) mkBar('c-mf-coll', wl, [
    { label:'Disbursed', data:bw.weeks.map(function(w){ return sum(bw.groups[w], dc); }), color:'#89D6E5' },
    { label:'Collected', data:bw.weeks.map(function(w){ return sum(bw.groups[w], collc); }), color:'#4ADE80' }
  ]);
  else if (dc && goalc) mkBar('c-mf-coll', wl, [
    { label:'Disbursed', data:bw.weeks.map(function(w){ return sum(bw.groups[w], dc); }), color:'#89D6E5' },
    { label:'Collection Goal', data:bw.weeks.map(function(w){ return sum(bw.groups[w], goalc); }), color:'#FBBF24' }
  ]);
  document.getElementById('ins-micro').innerHTML = '<strong>Microfinance:</strong> ' + fmtN(dc ? sum(mf.rows, dc) : 0) + ' loans disbursed.';
}

/* ==== HUB ==== */
function renderHub() {
  var hb = FDATA.Hub;
  if (!hb || !hb.rows.length) return;
  var h = hb.headers, wc = col(h,'Week');
  var revc = col(h,'Weekly Revenue'), evtc = col(h,'Events Hosted'), partc = col(h,'partnerships');
  var prosc = col(h,'Prospects'), footc = col(h,'foot traffic'), clic = col(h,'active clients'), bookc = col(h,'bookings');
  if (!wc) return;
  var bw = byWeek(hb.rows, wc), wl = bw.weeks.map(function(w){return 'W'+w;});
  if (revc) mkBar('c-hb-rev', wl, [{ label:'Revenue (UGX)', data:bw.weeks.map(function(w){ return sum(bw.groups[w], revc); }), color:'#4ADE80' }]);
  var evtS = [];
  if (evtc) evtS.push({ label:'Events', data:bw.weeks.map(function(w){ return sum(bw.groups[w], evtc); }), color:'#89D6E5' });
  if (partc) evtS.push({ label:'Partnerships', data:bw.weeks.map(function(w){ return sum(bw.groups[w], partc); }), color:'#A78BFA' });
  if (evtS.length) mkBar('c-hb-evt', wl, evtS);
  var prS = [];
  if (prosc) prS.push({ label:'Prospects', data:bw.weeks.map(function(w){ return sum(bw.groups[w], prosc); }), color:'#FBBF24' });
  if (footc) prS.push({ label:'Foot Traffic', data:bw.weeks.map(function(w){ return sum(bw.groups[w], footc); }), color:'#FC5E27' });
  if (prS.length) mkLine('c-hb-pros', wl, prS);
  var cS = [];
  if (clic) cS.push({ label:'Active Clients', data:bw.weeks.map(function(w){ return sum(bw.groups[w], clic); }), color:'#2690B1' });
  if (bookc) cS.push({ label:'Bookings', data:bw.weeks.map(function(w){ return sum(bw.groups[w], bookc); }), color:'#F87171' });
  if (cS.length) mkLine('c-hb-cli', wl, cS);
  document.getElementById('ins-hub').innerHTML = '<strong>Hub:</strong> ' + fmtUGX(revc ? sum(hb.rows, revc) : 0) + ' total revenue.';
}

/* ==== GROUP HR ==== */
function renderGroup() {
  var gr = FDATA['era92 Group'];
  if (!gr || !gr.rows.length) return;
  var h = gr.headers, wc = col(h,'Week');
  var appc = col(h,'Applications Received'), intc = col(h,'interviews completed'), hirec = col(h,'Hires'), trainc = col(h,'Trainings');
  if (!wc) return;
  var bw = byWeek(gr.rows, wc), wl = bw.weeks.map(function(w){return 'W'+w;});
  var s1 = [];
  if (appc) s1.push({ label:'Applications', data:bw.weeks.map(function(w){ return sum(bw.groups[w], appc); }), color:'#89D6E5' });
  if (intc) s1.push({ label:'Interviews', data:bw.weeks.map(function(w){ return sum(bw.groups[w], intc); }), color:'#FBBF24' });
  if (s1.length) mkBar('c-gr-app', wl, s1);
  var s2 = [];
  if (hirec) s2.push({ label:'Hires', data:bw.weeks.map(function(w){ return sum(bw.groups[w], hirec); }), color:'#4ADE80' });
  if (trainc) s2.push({ label:'Trainings', data:bw.weeks.map(function(w){ return sum(bw.groups[w], trainc); }), color:'#A78BFA' });
  if (s2.length) mkBar('c-gr-hire', wl, s2);
  document.getElementById('ins-group').innerHTML = '<strong>Group HR:</strong> ' + fmtN(hirec ? sum(gr.rows, hirec) : 0) + ' total hires.';
}

/* ==== INIT ==== */
google.charts.load('current');
google.charts.setOnLoadCallback(function() {
  var loadEl = document.getElementById('loading');
  var itemsEl = document.getElementById('load-items');
  var sheets = [
    { name:'Elevate', fn: function(){ return queryGSheet(KPI_ID, 'Elevate'); } },
    { name:'Employment', fn: function(){ return queryGSheet(KPI_ID, 'Employment'); } },
    { name:'Microfinance', fn: function(){ return queryGSheet(KPI_ID, 'Microfinance'); } },
    { name:'Hub', fn: function(){ return queryGSheet(KPI_ID, 'Hub'); } },
    { name:'era92 Group', fn: function(){ return queryGSheet(KPI_ID, 'era92 Group'); } },
    { name:'Revenue', fn: queryRevenue }
  ];
  var statuses = {};
  sheets.forEach(function(s) { statuses[s.name] = 'wait'; });
  function updateUI() {
    itemsEl.innerHTML = Object.keys(statuses).map(function(name) {
      var st = statuses[name];
      return '<span class="' + st + '">' + (st==='ok'?'\u2713':st==='err'?'\u2717':'\u23F3') + ' ' + name + '</span>';
    }).join('');
  }
  updateUI();
  Promise.all(sheets.map(function(s) {
    return s.fn().then(function(data) { DATA[s.name] = data; statuses[s.name] = 'ok'; updateUI(); })
      .catch(function(err) { console.warn('Failed:', s.name, err.message); ERRORS.push(s.name+': '+err.message); statuses[s.name] = 'err'; updateUI(); });
  })).then(function() {
    Object.keys(DATA).forEach(function(k) { FDATA[k] = DATA[k]; });
    loadEl.classList.add('hidden');
    if (ERRORS.length > 0) {
      var b = document.getElementById('error-banner');
      b.innerHTML = '<strong>Some sheets failed:</strong> ' + ERRORS.join('; ') + '<br><small>Ensure sheets are published to web.</small>';
      b.classList.add('show');
    }
    document.getElementById('last-updated').textContent = 'Updated ' + new Date().toLocaleString();
    populateFilters(); renderAll();
  });
});
</script>
</body>
</html>
