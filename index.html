<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>era92 Group — Live KPI Dashboard</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
:root {
  --primary: #1B3A5C;
  --accent: #E8632B;
  --accent2: #2ECC71;
  --accent3: #9B59B6;
  --accent4: #F39C12;
  --bg: #F4F6F9;
  --card: #FFFFFF;
  --text: #2C3E50;
  --muted: #7F8C8D;
  --border: #E0E4E8;
  --positive: #27ae60;
  --negative: #e74c3c;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); }

.header {
  background: linear-gradient(135deg, var(--primary) 0%, #2C5F8A 100%);
  color: white; padding: 24px 40px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;
}
.header h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }
.header .sub { opacity: 0.8; font-size: 13px; margin-top: 4px; }
.header-right { display: flex; align-items: center; gap: 12px; }
.refresh-btn {
  background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
  color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;
}
.refresh-btn:hover { background: rgba(255,255,255,0.25); }
.last-updated { font-size: 12px; opacity: 0.7; }

.filter-bar {
  display: flex; gap: 12px; padding: 12px 40px; background: white; border-bottom: 1px solid var(--border);
  flex-wrap: wrap; align-items: center;
}
.filter-group { display: flex; align-items: center; gap: 6px; }
.filter-group label { font-size: 12px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.filter-group select {
  padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px;
  font-size: 13px; color: var(--text); background: white; cursor: pointer;
}

.kpi-strip {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px; padding: 20px 40px; background: white; border-bottom: 1px solid var(--border);
}
.kpi { text-align: center; }
.kpi .value { font-size: 28px; font-weight: 700; color: var(--primary); }
.kpi .label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
.kpi .change { font-size: 12px; font-weight: 600; margin-top: 2px; }
.kpi .change.up { color: var(--positive); }
.kpi .change.down { color: var(--negative); }

.tabs {
  display: flex; gap: 0; padding: 0 40px; background: white; border-bottom: 2px solid var(--border); overflow-x: auto;
}
.tab {
  padding: 14px 22px; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--muted);
  border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;
}
.tab:hover { color: var(--text); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }

.content { padding: 24px 40px; max-width: 1400px; margin: 0 auto; }
.section { display: none; }
.section.active { display: block; }
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.full { grid-column: 1 / -1; }
.card {
  background: var(--card); border-radius: 12px; padding: 24px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06); border: 1px solid var(--border);
}
.card h3 { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 16px; }
.card canvas { width: 100% !important; max-height: 300px; }
.insight-box {
  background: #FFF8F0; border-left: 4px solid var(--accent); padding: 16px 20px;
  border-radius: 0 8px 8px 0; margin-bottom: 20px; font-size: 14px; line-height: 1.6;
}
.insight-box strong { color: var(--accent); }

.loading-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(244,246,249,0.95); display: flex; flex-direction: column;
  align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.3s;
}
.loading-overlay.hidden { opacity: 0; pointer-events: none; }
.spinner { width: 48px; height: 48px; border: 4px solid var(--border); border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 16px; }
@keyframes spin { to { transform: rotate(360deg); } }
.load-status { font-size: 14px; color: var(--muted); text-align: center; }
.load-items { margin-top: 12px; font-size: 12px; }
.load-items span { display: inline-block; margin: 2px 6px; padding: 2px 8px; border-radius: 10px; }
.load-items .ok { background: #e8f5e9; color: #2e7d32; }
.load-items .err { background: #fce4ec; color: #c62828; }
.load-items .wait { background: #f5f5f5; color: #9e9e9e; }

.error-banner {
  background: #fdf2f2; border: 1px solid #f5c6cb; color: #721c24;
  padding: 12px 20px; margin: 0 40px 16px; border-radius: 8px; font-size: 13px; display: none;
}
.error-banner.show { display: block; }

@media (max-width: 900px) {
  .grid2, .grid3 { grid-template-columns: 1fr; }
  .header, .content, .kpi-strip, .filter-bar { padding-left: 16px; padding-right: 16px; }
  .tabs { padding: 0 16px; }
  .kpi-strip { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>

<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="load-status">Pulling live data from Google Sheets...</div>
  <div class="load-items" id="load-items"></div>
</div>

<div class="error-banner" id="error-banner"></div>

<div class="header">
  <div>
    <h1>era92 Group Dashboard</h1>
    <div class="sub">Live KPI Tracker — <span id="date-range">Loading...</span></div>
  </div>
  <div class="header-right">
    <div class="last-updated" id="last-updated"></div>
    <button class="refresh-btn" onclick="location.reload()">Refresh Data</button>
  </div>
</div>

<div class="filter-bar">
  <div class="filter-group"><label>Week</label><select id="f-week" onchange="applyFilters()"><option value="">All</option></select></div>
  <div class="filter-group"><label>Quarter</label><select id="f-quarter" onchange="applyFilters()"><option value="">All</option></select></div>
  <div class="filter-group"><label>Year</label><select id="f-year" onchange="applyFilters()"><option value="">All</option></select></div>
  <div class="filter-group"><label>Location</label><select id="f-location" onchange="applyFilters()"><option value="">All</option></select></div>
  <div class="filter-group"><label>Brand</label><select id="f-brand" onchange="applyFilters()"><option value="">All</option></select></div>
</div>

<div class="kpi-strip">
  <div class="kpi"><div class="value" id="k-rev">—</div><div class="label">Total Revenue</div><div class="change" id="k-rev-c"></div></div>
  <div class="kpi"><div class="value" id="k-enr">—</div><div class="label">Enrollments</div><div class="change" id="k-enr-c"></div></div>
  <div class="kpi"><div class="value" id="k-plc">—</div><div class="label">Placements</div><div class="change" id="k-plc-c"></div></div>
  <div class="kpi"><div class="value" id="k-loan">—</div><div class="label">Loans Disbursed</div><div class="change" id="k-loan-c"></div></div>
  <div class="kpi"><div class="value" id="k-hub">—</div><div class="label">Hub Revenue</div><div class="change" id="k-hub-c"></div></div>
  <div class="kpi"><div class="value" id="k-hire">—</div><div class="label">Hires</div><div class="change" id="k-hire-c"></div></div>
</div>

<div class="tabs" id="tab-bar">
  <div class="tab active" data-tab="overview">Overview</div>
  <div class="tab" data-tab="revenue">Revenue</div>
  <div class="tab" data-tab="elevate">Elevate</div>
  <div class="tab" data-tab="employment">Employment</div>
  <div class="tab" data-tab="microfinance">Microfinance</div>
  <div class="tab" data-tab="hub">Hub</div>
  <div class="tab" data-tab="group">Group HR</div>
</div>

<div class="content">

<div class="section active" id="sec-overview">
  <div class="insight-box" id="ins-overview"><strong>Loading...</strong></div>
  <div class="grid2">
    <div class="card"><h3>Revenue by Brand</h3><canvas id="c-ov-brand"></canvas></div>
    <div class="card"><h3>Weekly Revenue Trend</h3><canvas id="c-ov-revtrend"></canvas></div>
  </div>
  <div class="grid3">
    <div class="card"><h3>Enrollment by Location</h3><canvas id="c-ov-enroll"></canvas></div>
    <div class="card"><h3>Placements by Week</h3><canvas id="c-ov-place"></canvas></div>
    <div class="card"><h3>Microfinance Loans</h3><canvas id="c-ov-loans"></canvas></div>
  </div>
</div>

<div class="section" id="sec-revenue">
  <div class="insight-box" id="ins-revenue"><strong>Loading...</strong></div>
  <div class="grid2">
    <div class="card"><h3>Revenue by Brand</h3><canvas id="c-rv-bar"></canvas></div>
    <div class="card"><h3>Revenue Share</h3><canvas id="c-rv-donut"></canvas></div>
  </div>
  <div class="grid2">
    <div class="card full"><h3>Weekly Revenue Trend by Brand</h3><canvas id="c-rv-trend"></canvas></div>
  </div>
</div>

<div class="section" id="sec-elevate">
  <div class="insight-box" id="ins-elevate"><strong>Loading...</strong></div>
  <div class="grid2">
    <div class="card"><h3>Weekly Enrollment by Hub</h3><canvas id="c-el-enroll"></canvas></div>
    <div class="card"><h3>Weekly Admissions by Hub</h3><canvas id="c-el-admit"></canvas></div>
  </div>
  <div class="grid2">
    <div class="card"><h3>Gender Split (Admissions)</h3><canvas id="c-el-gender"></canvas></div>
    <div class="card"><h3>Refugee Enrollment</h3><canvas id="c-el-refugee"></canvas></div>
  </div>
</div>

<div class="section" id="sec-employment">
  <div class="insight-box" id="ins-employment"><strong>Loading...</strong></div>
  <div class="grid2">
    <div class="card"><h3>New Placements by Week</h3><canvas id="c-em-place"></canvas></div>
    <div class="card"><h3>Income Earned (UGX)</h3><canvas id="c-em-income"></canvas></div>
  </div>
  <div class="grid2">
    <div class="card"><h3>Active Projects</h3><canvas id="c-em-proj"></canvas></div>
    <div class="card"><h3>Interviews Completed</h3><canvas id="c-em-intv"></canvas></div>
  </div>
</div>

<div class="section" id="sec-microfinance">
  <div class="insight-box" id="ins-micro"><strong>Loading...</strong></div>
  <div class="grid2">
    <div class="card"><h3>Loans Disbursed by Week</h3><canvas id="c-mf-disb"></canvas></div>
    <div class="card"><h3>Repayment Rate (%)</h3><canvas id="c-mf-rate"></canvas></div>
  </div>
  <div class="grid2">
    <div class="card"><h3>Loans at Risk (30+ days)</h3><canvas id="c-mf-risk"></canvas></div>
    <div class="card"><h3>Disbursed vs Collected</h3><canvas id="c-mf-coll"></canvas></div>
  </div>
</div>

<div class="section" id="sec-hub">
  <div class="insight-box" id="ins-hub"><strong>Loading...</strong></div>
  <div class="grid2">
    <div class="card"><h3>Hub Revenue by Week</h3><canvas id="c-hb-rev"></canvas></div>
    <div class="card"><h3>Events & Partnerships</h3><canvas id="c-hb-evt"></canvas></div>
  </div>
  <div class="grid2">
    <div class="card"><h3>Prospects & Foot Traffic</h3><canvas id="c-hb-pros"></canvas></div>
    <div class="card"><h3>Active Clients & Bookings</h3><canvas id="c-hb-cli"></canvas></div>
  </div>
</div>

<div class="section" id="sec-group">
  <div class="insight-box" id="ins-group"><strong>Loading...</strong></div>
  <div class="grid2">
    <div class="card"><h3>Applications & Interviews</h3><canvas id="c-gr-app"></canvas></div>
    <div class="card"><h3>Hires & Trainings</h3><canvas id="c-gr-hire"></canvas></div>
  </div>
</div>

</div>

<script>
/* ==================================================
   era92 Group Live Dashboard
   Uses Google Visualization API for reliable data fetch
   ================================================== */

var COLORS = ['#E8632B','#2ECC71','#3498DB','#9B59B6','#F39C12','#1ABC9C','#E74C3C','#34495E'];
var BRAND_COLORS = {'92 Cafe':'#E8632B','92 CarWash':'#3498DB','era92 Hub':'#2ECC71','era92 Creative':'#9B59B6','era92 Elevate':'#F39C12','era92 Finance':'#1ABC9C'};
var LOC_COLORS = {'Lungujja':'#E8632B','Katanga':'#3498DB','Jinja':'#2ECC71','Namayemba':'#9B59B6'};

var KPI_ID = '1fch4Cy5sj1VQ_iaD2NK0SoOE1EKjsr_7YmZSUt3-ngU';
var REV_ID = '1n4eFTqFmyvm9xEY-meoio2v6qFoCow7mwC6BU0wNAhI';

/* ---- Global state ---- */
var DATA = {};          // raw sheet data
var FDATA = {};         // filtered data
var CHARTS = {};        // chart instances
var ERRORS = [];

/* ---- Tab switching ---- */
document.getElementById('tab-bar').addEventListener('click', function(e) {
  var tab = e.target.closest('.tab');
  if (!tab) return;
  document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
  tab.classList.add('active');
  var sec = document.getElementById('sec-' + tab.getAttribute('data-tab'));
  if (sec) sec.classList.add('active');
});

/* ---- Query Google Sheet via Visualization API ---- */
function queryGSheet(sheetId, tabName) {
  return new Promise(function(resolve, reject) {
    try {
      var url = 'https://docs.google.com/spreadsheets/d/' + sheetId + '/gviz/tq?sheet=' + encodeURIComponent(tabName);
      var q = new google.visualization.Query(url);
      q.setTimeout(20);
      q.send(function(resp) {
        try {
          if (resp.isError()) { reject(new Error(resp.getMessage())); return; }
          var t = resp.getDataTable();
          var nc = t.getNumberOfColumns(), nr = t.getNumberOfRows();
          var hdrs = [];
          for (var c = 0; c < nc; c++) hdrs.push(t.getColumnLabel(c) || t.getColumnId(c));
          var rows = [];
          for (var r = 0; r < nr; r++) {
            var obj = {}, hasVal = false;
            for (var c2 = 0; c2 < nc; c2++) {
              var v = t.getValue(r, c2);
              obj[hdrs[c2]] = v;
              if (v !== null && v !== undefined && v !== '') hasVal = true;
            }
            if (hasVal) rows.push(obj);
          }
          resolve({ headers: hdrs, rows: rows });
        } catch (e) { reject(e); }
      });
    } catch (e) { reject(e); }
  });
}

/* ---- Revenue sheet: no labels, map by column index ---- */
function queryRevenue() {
  return new Promise(function(resolve, reject) {
    try {
      var url = 'https://docs.google.com/spreadsheets/d/' + REV_ID + '/gviz/tq?sheet=Sheet1';
      var q = new google.visualization.Query(url);
      q.setTimeout(20);
      q.send(function(resp) {
        try {
          if (resp.isError()) { reject(new Error(resp.getMessage())); return; }
          var t = resp.getDataTable();
          var nr = t.getNumberOfRows(), nc = t.getNumberOfColumns();
          // Column mapping by position (from the sheet structure):
          // 0=Dates, 1=Week, 2=Quarter, 3=Year, 4=Enterprise, 5=Revenue
          var COLS = { Dates:0, Week:1, Quarter:2, Year:3, Enterprise:4, Revenue:5, NewDonors:7 };
          var rows = [];
          for (var r = 0; r < nr; r++) {
            var enterprise = t.getValue(r, COLS.Enterprise);
            var revenue = t.getValue(r, COLS.Revenue);
            // Skip non-data rows (totals, headers, empty)
            if (!enterprise || typeof enterprise !== 'string') continue;
            if (enterprise.toLowerCase().includes('total') || enterprise.toLowerCase().includes('enterprise')) continue;
            rows.push({
              Dates: t.getValue(r, COLS.Dates),
              Week: t.getValue(r, COLS.Week),
              Quarter: t.getValue(r, COLS.Quarter),
              Year: t.getValue(r, COLS.Year),
              Enterprise: enterprise.trim(),
              Revenue: typeof revenue === 'number' ? revenue : parseFloat(String(revenue).replace(/,/g,'')) || 0,
              NewDonors: t.getValue(r, COLS.NewDonors)
            });
          }
          resolve({ headers: ['Dates','Week','Quarter','Year','Enterprise','Revenue','NewDonors'], rows: rows });
        } catch (e) { reject(e); }
      });
    } catch (e) { reject(e); }
  });
}

/* ---- Utilities ---- */
function N(v) { return typeof v === 'number' ? v : parseFloat(v) || 0; }
function fmtUGX(v) {
  v = N(v);
  if (v >= 1e9) return 'UGX ' + (v/1e9).toFixed(1) + 'B';
  if (v >= 1e6) return 'UGX ' + (v/1e6).toFixed(1) + 'M';
  if (v >= 1e3) return 'UGX ' + (v/1e3).toFixed(0) + 'K';
  return 'UGX ' + Math.round(v).toLocaleString();
}
function fmtN(v) { v = N(v); if (v >= 1e6) return (v/1e6).toFixed(1)+'M'; if (v >= 1e3) return (v/1e3).toFixed(1)+'K'; return Math.round(v).toLocaleString(); }
function sum(rows, col) { return rows.reduce(function(s,r){ return s + N(r[col]); }, 0); }
function col(hdrs) {
  // Return the first header that contains one of the given keywords
  var args = Array.prototype.slice.call(arguments, 1);
  for (var i = 0; i < args.length; i++) {
    var kw = args[i].toLowerCase();
    var m = hdrs.find(function(h){ return h && h.toLowerCase().indexOf(kw) >= 0; });
    if (m) return m;
  }
  return null;
}

/* ---- Group rows by week ---- */
function byWeek(rows, weekCol) {
  var g = {};
  rows.forEach(function(r) {
    var w = N(r[weekCol]);
    if (!w) return;
    if (!g[w]) g[w] = [];
    g[w].push(r);
  });
  var weeks = Object.keys(g).map(Number).sort(function(a,b){return a-b;});
  return { weeks: weeks, groups: g };
}

/* ---- Chart factory ---- */
function mk(id, type, labels, datasets, opts) {
  if (CHARTS[id]) CHARTS[id].destroy();
  var el = document.getElementById(id);
  if (!el) return;
  var base = {
    responsive: true, maintainAspectRatio: false, animation: false,
    plugins: { legend: { position:'top', labels: { usePointStyle:true, padding:12, font:{size:11} } } },
    scales: type==='doughnut'||type==='pie' ? {} : { x:{grid:{display:false}}, y:{beginAtZero:true, grid:{color:'#f0f0f0'}} }
  };
  var o = Object.assign({}, base, opts || {});
  CHARTS[id] = new Chart(el, { type:type, data:{labels:labels, datasets:datasets}, options:o });
}

function mkLine(id, labels, series) {
  mk(id, 'line', labels, series.map(function(s,i){
    return { label:s.label, data:s.data, borderColor:s.color||COLORS[i%COLORS.length], backgroundColor:(s.color||COLORS[i%COLORS.length])+'20', borderWidth:2, fill:false, tension:0.3, pointRadius:3 };
  }));
}
function mkBar(id, labels, series, stacked) {
  var ds = series.map(function(s,i){ return { label:s.label, data:s.data, backgroundColor:s.color||COLORS[i%COLORS.length], borderRadius:4 }; });
  var opts = stacked ? { scales:{x:{stacked:true,grid:{display:false}},y:{stacked:true,beginAtZero:true,grid:{color:'#f0f0f0'}}} } : undefined;
  mk(id, 'bar', labels, ds, opts);
}
function mkDonut(id, labels, data) {
  mk(id, 'doughnut', labels, [{ data:data, backgroundColor:labels.map(function(l,i){ return BRAND_COLORS[l]||COLORS[i%COLORS.length]; }), borderWidth:2, borderColor:'#fff' }], { cutout:'55%' });
}

/* ==== FILTERS ==== */
function applyFilters() {
  var fw = document.getElementById('f-week').value;
  var fq = document.getElementById('f-quarter').value;
  var fy = document.getElementById('f-year').value;
  var fl = document.getElementById('f-location').value;
  var fb = document.getElementById('f-brand').value;

  Object.keys(DATA).forEach(function(name) {
    var sheet = DATA[name];
    if (!sheet || !sheet.rows) { FDATA[name] = sheet; return; }
    var h = sheet.headers;
    var wc = col(h,'Week');
    var qc = col(h,'Quarter');
    var yc = col(h,'Year');
    var lc = col(h,'Hub Location','Location','Branch');
    var bc = col(h,'Enterprise','Brand');

    FDATA[name] = {
      headers: h,
      rows: sheet.rows.filter(function(r) {
        if (fw && wc && N(r[wc]) !== N(fw)) return false;
        if (fq && qc && String(N(r[qc])) !== fq) return false;
        if (fy && yc && String(N(r[yc])) !== fy) return false;
        if (fl && lc && String(r[lc]) !== fl) return false;
        if (fb && bc && String(r[bc]) !== fb) return false;
        return true;
      })
    };
  });
  renderAll();
}

function populateFilters() {
  var weeks = new Set(), quarters = new Set(), years = new Set(), locations = new Set(), brands = new Set();
  Object.values(DATA).forEach(function(s) {
    if (!s || !s.rows) return;
    s.rows.forEach(function(r) {
      var wc = col(s.headers,'Week');
      if (wc && N(r[wc])) weeks.add(N(r[wc]));
      var qc = col(s.headers,'Quarter');
      if (qc && r[qc]) quarters.add(String(N(r[qc])));
      var yc = col(s.headers,'Year');
      if (yc && r[yc]) years.add(String(N(r[yc])));
      var lc = col(s.headers,'Hub Location','Location','Branch');
      if (lc && r[lc]) locations.add(String(r[lc]));
      var bc = col(s.headers,'Enterprise','Brand');
      if (bc && r[bc]) brands.add(String(r[bc]));
    });
  });

  function fill(selId, vals, prefix) {
    var sel = document.getElementById(selId);
    var arr = Array.from(vals).sort(function(a,b){ return N(a)-N(b)||String(a).localeCompare(String(b)); });
    arr.forEach(function(v) {
      if (!v || v==='NaN') return;
      var o = document.createElement('option');
      o.value = v; o.textContent = (prefix||'') + v;
      sel.appendChild(o);
    });
  }
  fill('f-week', weeks, 'Week ');
  fill('f-quarter', quarters, 'Q');
  fill('f-year', years, '');
  fill('f-location', locations, '');
  fill('f-brand', brands, '');

  if (weeks.size > 0) {
    var maxW = Math.max.apply(null, Array.from(weeks));
    var minW = Math.min.apply(null, Array.from(weeks));
    var yr = years.size > 0 ? Math.max.apply(null, Array.from(years).map(Number)) : 2026;
    document.getElementById('date-range').textContent = 'Weeks ' + minW + '–' + maxW + ', ' + yr;
  }
}

/* ==== RENDER ALL ==== */
function renderAll() {
  try { renderKPIs(); } catch(e) { console.warn('KPI error:', e); }
  try { renderOverview(); } catch(e) { console.warn('Overview error:', e); }
  try { renderRevenue(); } catch(e) { console.warn('Revenue error:', e); }
  try { renderElevate(); } catch(e) { console.warn('Elevate error:', e); }
  try { renderEmployment(); } catch(e) { console.warn('Employment error:', e); }
  try { renderMicrofinance(); } catch(e) { console.warn('Microfinance error:', e); }
  try { renderHub(); } catch(e) { console.warn('Hub error:', e); }
  try { renderGroup(); } catch(e) { console.warn('Group error:', e); }
}

/* ==== KPIs ==== */
function renderKPIs() {
  // Revenue
  var rv = FDATA.Revenue;
  if (rv && rv.rows.length) {
    document.getElementById('k-rev').textContent = fmtUGX(sum(rv.rows, 'Revenue'));
  }
  // Enrollments
  var el = FDATA.Elevate;
  if (el && el.rows.length) {
    var ec = col(el.headers, 'enrolled');
    if (ec) document.getElementById('k-enr').textContent = fmtN(sum(el.rows, ec));
  }
  // Placements
  var em = FDATA.Employment;
  if (em && em.rows.length) {
    var pc = col(em.headers, 'New placements');
    if (pc) document.getElementById('k-plc').textContent = fmtN(sum(em.rows, pc));
  }
  // Loans
  var mf = FDATA.Microfinance;
  if (mf && mf.rows.length) {
    var lc = col(mf.headers, 'Loans disbursed this week');
    if (lc) document.getElementById('k-loan').textContent = fmtN(sum(mf.rows, lc));
  }
  // Hub Revenue
  var hb = FDATA.Hub;
  if (hb && hb.rows.length) {
    var hrc = col(hb.headers, 'Weekly Revenue');
    if (hrc) document.getElementById('k-hub').textContent = fmtUGX(sum(hb.rows, hrc));
  }
  // Hires
  var gr = FDATA['era92 Group'];
  if (gr && gr.rows.length) {
    var hc = col(gr.headers, 'Hires');
    if (hc) document.getElementById('k-hire').textContent = fmtN(sum(gr.rows, hc));
  }
}

/* ==== OVERVIEW ==== */
function renderOverview() {
  var rv = FDATA.Revenue;
  if (rv && rv.rows.length) {
    // Revenue by brand
    var bb = {};
    rv.rows.forEach(function(r) { var b = r.Enterprise; bb[b] = (bb[b]||0) + N(r.Revenue); });
    var brands = Object.keys(bb).sort(function(a,b){ return bb[b]-bb[a]; });
    mkBar('c-ov-brand', brands, [{ label:'Revenue (UGX)', data:brands.map(function(b){return bb[b];}) }]);

    // Weekly trend
    var wk = col(rv.headers, 'Week');
    if (wk) {
      var bw = byWeek(rv.rows, wk);
      var wl = bw.weeks.map(function(w){return 'W'+w;});
      mkLine('c-ov-revtrend', wl, [{ label:'Total Revenue', data:bw.weeks.map(function(w){ return sum(bw.groups[w],'Revenue'); }), color:'#E8632B' }]);
    }
  }

  // Enrollment by location
  var el = FDATA.Elevate;
  if (el && el.rows.length) {
    var wc = col(el.headers, 'Week');
    var ec = col(el.headers, 'enrolled');
    var lc2 = col(el.headers, 'Hub Location');
    if (wc && ec) {
      var bw2 = byWeek(el.rows, wc);
      var wl2 = bw2.weeks.map(function(w){return 'W'+w;});
      if (lc2) {
        var locs = ['Lungujja','Katanga','Jinja','Namayemba'];
        mkBar('c-ov-enroll', wl2, locs.map(function(loc){
          return { label:loc, data:bw2.weeks.map(function(w){ return sum(bw2.groups[w].filter(function(r){return r[lc2]===loc;}), ec); }), color:LOC_COLORS[loc] };
        }), true);
      } else {
        mkBar('c-ov-enroll', wl2, [{ label:'Enrollments', data:bw2.weeks.map(function(w){ return sum(bw2.groups[w], ec); }) }]);
      }
    }
  }

  // Placements
  var em = FDATA.Employment;
  if (em && em.rows.length) {
    var wc3 = col(em.headers, 'Week');
    var pc = col(em.headers, 'New placements');
    if (wc3 && pc) {
      var bw3 = byWeek(em.rows, wc3);
      mkBar('c-ov-place', bw3.weeks.map(function(w){return 'W'+w;}), [{ label:'Placements', data:bw3.weeks.map(function(w){ return sum(bw3.groups[w], pc); }), color:'#2ECC71' }]);
    }
  }

  // Microfinance
  var mf = FDATA.Microfinance;
  if (mf && mf.rows.length) {
    var wc4 = col(mf.headers, 'Week');
    var dc = col(mf.headers, 'Loans disbursed this week');
    if (wc4 && dc) {
      var bw4 = byWeek(mf.rows, wc4);
      mkBar('c-ov-loans', bw4.weeks.map(function(w){return 'W'+w;}), [{ label:'Loans', data:bw4.weeks.map(function(w){ return sum(bw4.groups[w], dc); }), color:'#3498DB' }]);
    }
  }

  var loaded = Object.keys(FDATA).filter(function(k){ return FDATA[k] && FDATA[k].rows && FDATA[k].rows.length > 0; });
  document.getElementById('ins-overview').innerHTML = '<strong>Dashboard Overview:</strong> Showing live data from ' + loaded.length + ' sources. Use filters to drill down by week, quarter, brand, or location.';
}

/* ==== REVENUE ==== */
function renderRevenue() {
  var rv = FDATA.Revenue;
  if (!rv || !rv.rows.length) return;

  var bb = {};
  rv.rows.forEach(function(r) { bb[r.Enterprise] = (bb[r.Enterprise]||0) + N(r.Revenue); });
  var brands = Object.keys(bb).sort(function(a,b){ return bb[b]-bb[a]; });
  mkBar('c-rv-bar', brands, [{ label:'Revenue (UGX)', data:brands.map(function(b){return bb[b];}) }]);
  mkDonut('c-rv-donut', brands, brands.map(function(b){return bb[b];}));

  // Trend by brand
  var bw = byWeek(rv.rows, 'Week');
  var wl = bw.weeks.map(function(w){return 'W'+w;});
  mkLine('c-rv-trend', wl, brands.slice(0,6).map(function(b){
    return { label:b, data:bw.weeks.map(function(w){ return sum(bw.groups[w].filter(function(r){return r.Enterprise===b;}), 'Revenue'); }), color:BRAND_COLORS[b] };
  }));

  var total = Object.values(bb).reduce(function(s,v){return s+v;},0);
  document.getElementById('ins-revenue').innerHTML = '<strong>Revenue:</strong> ' + fmtUGX(total) + ' total. Top brand: ' + brands[0] + ' (' + fmtUGX(bb[brands[0]]) + ').';
}

/* ==== ELEVATE ==== */
function renderElevate() {
  var el = FDATA.Elevate;
  if (!el || !el.rows.length) return;
  var h = el.headers;
  var wc = col(h,'Week'), lc = col(h,'Hub Location');
  var ec = col(h,'enrolled'), ac = col(h,'admitted'), mc = col(h,'Male'), fc = col(h,'Female'), rc = col(h,'Refugee');

  if (!wc) return;
  var bw = byWeek(el.rows, wc);
  var wl = bw.weeks.map(function(w){return 'W'+w;});
  var locs = ['Lungujja','Katanga','Jinja','Namayemba'];

  // Enrollment by hub
  if (ec && lc) {
    mkBar('c-el-enroll', wl, locs.map(function(loc){
      return { label:loc, data:bw.weeks.map(function(w){ return sum(bw.groups[w].filter(function(r){return r[lc]===loc;}), ec); }), color:LOC_COLORS[loc] };
    }), true);
  }

  // Admissions by hub
  if (ac && lc) {
    mkBar('c-el-admit', wl, locs.map(function(loc){
      return { label:loc, data:bw.weeks.map(function(w){ return sum(bw.groups[w].filter(function(r){return r[lc]===loc;}), ac); }), color:LOC_COLORS[loc] };
    }), true);
  }

  // Gender
  if (mc && fc) {
    mkBar('c-el-gender', wl, [
      { label:'Male', data:bw.weeks.map(function(w){ return sum(bw.groups[w], mc); }), color:'#3498DB' },
      { label:'Female', data:bw.weeks.map(function(w){ return sum(bw.groups[w], fc); }), color:'#E74C3C' }
    ], true);
  }

  // Refugees
  if (rc) {
    mkBar('c-el-refugee', wl, [{ label:'Refugees', data:bw.weeks.map(function(w){ return sum(bw.groups[w], rc); }), color:'#9B59B6' }]);
  }

  var totalE = ec ? sum(el.rows, ec) : 0;
  var totalA = ac ? sum(el.rows, ac) : 0;
  document.getElementById('ins-elevate').innerHTML = '<strong>Elevate:</strong> ' + fmtN(totalE) + ' enrolled, ' + fmtN(totalA) + ' admitted across ' + bw.weeks.length + ' weeks.';
}

/* ==== EMPLOYMENT ==== */
function renderEmployment() {
  var em = FDATA.Employment;
  if (!em || !em.rows.length) return;
  var h = em.headers;
  var wc = col(h,'Week');
  var pc = col(h,'New placements');
  var ic = col(h,'income earned');
  var prc = col(h,'active projects');
  var intc = col(h,'interviews completed');

  if (!wc) return;
  var bw = byWeek(em.rows, wc);
  var wl = bw.weeks.map(function(w){return 'W'+w;});

  if (pc) mkBar('c-em-place', wl, [{ label:'New Placements', data:bw.weeks.map(function(w){ return sum(bw.groups[w], pc); }), color:'#2ECC71' }]);
  if (ic) mkLine('c-em-income', wl, [{ label:'Income (UGX)', data:bw.weeks.map(function(w){ return sum(bw.groups[w], ic); }), color:'#27ae60' }]);
  if (prc) mkLine('c-em-proj', wl, [{ label:'Active Projects', data:bw.weeks.map(function(w){ return sum(bw.groups[w], prc); }), color:'#3498DB' }]);
  if (intc) mkBar('c-em-intv', wl, [{ label:'Interviews', data:bw.weeks.map(function(w){ return sum(bw.groups[w], intc); }), color:'#F39C12' }]);

  var tp = pc ? sum(em.rows, pc) : 0;
  var ti = ic ? sum(em.rows, ic) : 0;
  document.getElementById('ins-employment').innerHTML = '<strong>Employment:</strong> ' + fmtN(tp) + ' placements, ' + fmtUGX(ti) + ' income earned.';
}

/* ==== MICROFINANCE ==== */
function renderMicrofinance() {
  var mf = FDATA.Microfinance;
  if (!mf || !mf.rows.length) return;
  var h = mf.headers;
  var wc = col(h,'Week');
  var dc = col(h,'Loans disbursed this week');
  var ratec = col(h,'Repayment rate');
  var riskc = col(h,'loans at risk');
  var collc = col(h,'Actual Weekly repayment');
  var goalc = col(h,'Weekly Collection Goal');

  if (!wc) return;
  var bw = byWeek(mf.rows, wc);
  var wl = bw.weeks.map(function(w){return 'W'+w;});

  if (dc) mkBar('c-mf-disb', wl, [{ label:'Loans Disbursed', data:bw.weeks.map(function(w){ return sum(bw.groups[w], dc); }), color:'#3498DB' }]);

  if (ratec) {
    mkLine('c-mf-rate', wl, [{ label:'Repayment Rate %', data:bw.weeks.map(function(w){
      var vals = bw.groups[w].map(function(r){ return N(r[ratec]); }).filter(function(v){ return v > 0; });
      return vals.length ? vals.reduce(function(s,v){return s+v;},0)/vals.length : 0;
    }), color:'#27ae60' }]);
  }

  if (riskc) mkBar('c-mf-risk', wl, [{ label:'Loans at Risk', data:bw.weeks.map(function(w){ return sum(bw.groups[w], riskc); }), color:'#E74C3C' }]);

  if (dc && collc) {
    mkBar('c-mf-coll', wl, [
      { label:'Disbursed', data:bw.weeks.map(function(w){ return sum(bw.groups[w], dc); }), color:'#3498DB' },
      { label:'Collected', data:bw.weeks.map(function(w){ return sum(bw.groups[w], collc); }), color:'#27ae60' }
    ]);
  } else if (dc && goalc) {
    mkBar('c-mf-coll', wl, [
      { label:'Disbursed', data:bw.weeks.map(function(w){ return sum(bw.groups[w], dc); }), color:'#3498DB' },
      { label:'Collection Goal', data:bw.weeks.map(function(w){ return sum(bw.groups[w], goalc); }), color:'#F39C12' }
    ]);
  }

  var td = dc ? sum(mf.rows, dc) : 0;
  document.getElementById('ins-micro').innerHTML = '<strong>Microfinance:</strong> ' + fmtN(td) + ' loans disbursed.';
}

/* ==== HUB ==== */
function renderHub() {
  var hb = FDATA.Hub;
  if (!hb || !hb.rows.length) return;
  var h = hb.headers;
  var wc = col(h,'Week');
  var revc = col(h,'Weekly Revenue');
  var evtc = col(h,'Events Hosted');
  var partc = col(h,'partnerships');
  var prosc = col(h,'Prospects');
  var footc = col(h,'foot traffic');
  var clic = col(h,'active clients');
  var bookc = col(h,'bookings');

  if (!wc) return;
  var bw = byWeek(hb.rows, wc);
  var wl = bw.weeks.map(function(w){return 'W'+w;});

  if (revc) mkBar('c-hb-rev', wl, [{ label:'Revenue (UGX)', data:bw.weeks.map(function(w){ return sum(bw.groups[w], revc); }), color:'#2ECC71' }]);

  var evtSeries = [];
  if (evtc) evtSeries.push({ label:'Events', data:bw.weeks.map(function(w){ return sum(bw.groups[w], evtc); }), color:'#3498DB' });
  if (partc) evtSeries.push({ label:'Partnerships', data:bw.weeks.map(function(w){ return sum(bw.groups[w], partc); }), color:'#9B59B6' });
  if (evtSeries.length) mkBar('c-hb-evt', wl, evtSeries);

  var prosSeries = [];
  if (prosc) prosSeries.push({ label:'Prospects', data:bw.weeks.map(function(w){ return sum(bw.groups[w], prosc); }), color:'#F39C12' });
  if (footc) prosSeries.push({ label:'Foot Traffic', data:bw.weeks.map(function(w){ return sum(bw.groups[w], footc); }), color:'#E8632B' });
  if (prosSeries.length) mkLine('c-hb-pros', wl, prosSeries);

  var cliSeries = [];
  if (clic) cliSeries.push({ label:'Active Clients', data:bw.weeks.map(function(w){ return sum(bw.groups[w], clic); }), color:'#1ABC9C' });
  if (bookc) cliSeries.push({ label:'Bookings', data:bw.weeks.map(function(w){ return sum(bw.groups[w], bookc); }), color:'#E74C3C' });
  if (cliSeries.length) mkLine('c-hb-cli', wl, cliSeries);

  var tr = revc ? sum(hb.rows, revc) : 0;
  document.getElementById('ins-hub').innerHTML = '<strong>Hub:</strong> ' + fmtUGX(tr) + ' total revenue.';
}

/* ==== GROUP HR ==== */
function renderGroup() {
  var gr = FDATA['era92 Group'];
  if (!gr || !gr.rows.length) return;
  var h = gr.headers;
  var wc = col(h,'Week');
  var appc = col(h,'Applications Received');
  var intc = col(h,'interviews completed');
  var hirec = col(h,'Hires');
  var trainc = col(h,'Trainings');

  if (!wc) return;
  var bw = byWeek(gr.rows, wc);
  var wl = bw.weeks.map(function(w){return 'W'+w;});

  var s1 = [];
  if (appc) s1.push({ label:'Applications', data:bw.weeks.map(function(w){ return sum(bw.groups[w], appc); }), color:'#3498DB' });
  if (intc) s1.push({ label:'Interviews', data:bw.weeks.map(function(w){ return sum(bw.groups[w], intc); }), color:'#F39C12' });
  if (s1.length) mkBar('c-gr-app', wl, s1);

  var s2 = [];
  if (hirec) s2.push({ label:'Hires', data:bw.weeks.map(function(w){ return sum(bw.groups[w], hirec); }), color:'#2ECC71' });
  if (trainc) s2.push({ label:'Trainings', data:bw.weeks.map(function(w){ return sum(bw.groups[w], trainc); }), color:'#9B59B6' });
  if (s2.length) mkBar('c-gr-hire', wl, s2);

  var th = hirec ? sum(gr.rows, hirec) : 0;
  document.getElementById('ins-group').innerHTML = '<strong>Group HR:</strong> ' + fmtN(th) + ' total hires.';
}

/* ==== INIT ==== */
google.charts.load('current');
google.charts.setOnLoadCallback(function() {
  loadDashboard();
});

function loadDashboard() {
  var loadEl = document.getElementById('loading');
  var itemsEl = document.getElementById('load-items');

  // Sheets to load
  var sheets = [
    { name:'Elevate', fn: function(){ return queryGSheet(KPI_ID, 'Elevate'); } },
    { name:'Employment', fn: function(){ return queryGSheet(KPI_ID, 'Employment'); } },
    { name:'Microfinance', fn: function(){ return queryGSheet(KPI_ID, 'Microfinance'); } },
    { name:'Hub', fn: function(){ return queryGSheet(KPI_ID, 'Hub'); } },
    { name:'era92 Group', fn: function(){ return queryGSheet(KPI_ID, 'era92 Group'); } },
    { name:'Revenue', fn: queryRevenue }
  ];

  var statuses = {};
  sheets.forEach(function(s) { statuses[s.name] = 'wait'; });

  function updateLoadUI() {
    itemsEl.innerHTML = Object.keys(statuses).map(function(name) {
      var st = statuses[name];
      var icon = st === 'ok' ? '\u2713' : st === 'err' ? '\u2717' : '\u23F3';
      return '<span class="' + st + '">' + icon + ' ' + name + '</span>';
    }).join(' ');
  }
  updateLoadUI();

  var promises = sheets.map(function(s) {
    return s.fn()
      .then(function(data) {
        DATA[s.name] = data;
        statuses[s.name] = 'ok';
        updateLoadUI();
      })
      .catch(function(err) {
        console.warn('Failed:', s.name, err.message);
        ERRORS.push(s.name + ': ' + err.message);
        statuses[s.name] = 'err';
        updateLoadUI();
      });
  });

  Promise.all(promises).then(function() {
    // Copy raw -> filtered
    Object.keys(DATA).forEach(function(k) { FDATA[k] = DATA[k]; });

    // Hide loading
    loadEl.classList.add('hidden');

    // Show errors
    if (ERRORS.length > 0) {
      var banner = document.getElementById('error-banner');
      banner.innerHTML = '<strong>Some sheets failed:</strong> ' + ERRORS.join('; ') +
        '<br><small>Make sure sheets are published to web (File > Share > Publish to web).</small>';
      banner.classList.add('show');
    }

    document.getElementById('last-updated').textContent = 'Updated: ' + new Date().toLocaleString();

    populateFilters();
    renderAll();
  }).catch(function(err) {
    // This shouldn't happen since individual errors are caught, but just in case
    loadEl.classList.add('hidden');
    var banner = document.getElementById('error-banner');
    banner.innerHTML = '<strong>Error:</strong> ' + err.message;
    banner.classList.add('show');
  });
}
</script>
</body>
</html>
